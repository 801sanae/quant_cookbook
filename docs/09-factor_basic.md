# 퀀트 전략을 이용한 종목선정 (기본)

API와 크롤링을 이용하여 데이터를 모두 수집한 뒤, 이를 정리하였습니다. 데이터가 준비되었으므로 이제 각종 퀀트 전략을 활용하여 투자하고자 하는 종목을 선정해야 합니다. 

퀀트 투자는 크게 포트폴리오 운용 전략과 트레이딩 전략으로 나눌 수 있습니다. 포트폴트폴리오 운용 전략의 경우 과거 주식 시장을 분석하여 좋은 주식의 기준을 찾아낸 후 해당 기준에 만족하는 종목을 매수하거나, 이와 정반대에 있는 나쁜 주식을 공매도 하기도 합니다. 투자의 속도가 매우 느리며, 다수의 종목을 하나의 포트폴리오로 구성하여 운용하는 특징이 있습니다. 반면 트레이딩 전략의 경우, 단기간에 발생되는 주식의 움직임을 연구한 후 예측하여, 매수 혹은 매도하는 전략입니다. 투자의 속도가 매우 빠르며 소수의 종목을 대상으로 합니다.


Table: (\#tab:unnamed-chunk-1)퀀트 투자 종류의 비교

기준          포트폴리오 운용 전략   트레이딩 전략             
------------  ---------------------  --------------------------
투자철학      규칙에 기반한 투자     규칙에 기반한 투자        
투자목적      좋은 주식을 매수       좋은 시점을 매수          
학문적 기반   경제학, 통계학 등      통계학, 공학, 정보처리 등 
투자의 속도   느림                   빠름                      

이 중 본 책에서는 포트폴리오에 기반한 운용 전략에 대해 다루도록 합니다. 과거의 데이터를 바탕으로 주식의 수익률에 영향을 지표를 팩터^Factor^라 합니다. 즉 팩터의 강도가 양인 종목들로 구성한 포트폴리오의 경우 향후 수익률이 높을 것으로 예상되며, 팩터의 강도가 음인 종목들로 구성한 포트폴리오의 경우 반대로 향후 수익률이 낮을 것으로 예상됩니다.

팩터에 대한 연구는 학자들에 의해 수십년간 끊임없이 진행되어 왔지만, 일반 투자자들이 이러한 논문을 모두 찾아보고 연구하는 것은 사실상 불가능에 가깝습니다. 그러나 최근에는 **스마트베타**라는 이름으로 팩터 투자가 대중화되고 있습니다. 최근 유행하고 있는 스마트베타 ETF의 경우 팩터를 기준으로 포트폴리오를 구성한 상품으로써, 학계나 실무에서 검증된 팩터 전략을 기반으로 합니다.

해당 상품들의 홈페이지나 투자설명서에는 종목 선정 기준에 대해 자세히 나와있으므로 이는 매우 훌륭한 투자 전략이기도 합니다. 따라서 스마트베타 ETF에 나와있는 투자 전략을 자세히 분석하는 것만으로도 훌륭한 퀀트 투자 전략을 만들 수 있습니다. 

<div class="figure" style="text-align: center">
<img src="images/factor_smartbeta.png" alt="스마트베타 ETF 전략 예시" width="70%" />
<p class="caption">(\#fig:unnamed-chunk-2)스마트베타 ETF 전략 예시</p>
</div>

본 장에서는 투자에 많이 활용되는 기본적인 팩터에 대해 알아보고, 우리가 구한 데이터를 바탕으로 각 팩터 별 투자 종목을 선택하는 방법에 대해 알아보도록 하겠습니다.

아울러 본 책에서 각종 모델을 통해 나온 종목들은, 데이터를 받은 시점에서의 종목이며 매수 추천은 아님을 밝힙니다.

## 베타 이해하기

투자자들이라면 누구나 한번 쯤 들어봤을만한 용어가 베타^Beta^ 입니다. 기본적으로 개별 주식의 수익률에 가장 크게 영향을 주는 요소는 주식시장의 움직임일수 밖에 없습니다. 아무리 좋은 주식도 주식시장이 폭락한다면 같이 떨어지며, 아무리 나쁜 주식도 주식시장이 급등한다면 대부분 같이 오르기 마련입니다.

개별 주식이 전체 주식시장의 변동에 반응하는 정도를 나타낸 값이 베타입니다. 베타가 1이라는 뜻은 주식시장과 움직임이 정확히같다는 뜻으로써, 시장 그 자체를 나타냅니다. 베타가 1.5라는 뜻은 주식시장이 수익률이 +1% 일 때 개별 주식의 수익률은 +1.5% 이며, 반대로 주식시장의 수익률이 -1% 일 때 개별 주식의 수익률은 -1.5% 입니다. 반면 베타가 0.5라는 주식시장 수익률의 절반 정도만이 움직이게 됩니다.


Table: (\#tab:unnamed-chunk-3)베타에 따른 개별 주식의 수익률 움직임

베타   주식시장이 +1% 일 경우   주식시장이 -1% 일 경우 
-----  -----------------------  -----------------------
0.5    +0.5%                    -0.5%                  
1.0    +1.0%                    -1.0%                  
1.5    +1.5%                    -1.5%                  

이처럼 베타가 큰 주식은 주식시장보다 수익률의 움직임이 크며, 반대로 베타가 낮은 주식은 주식시장보다 수익률의 움직임이 작습니다. 따라서 일반적으로 상승장이 기대될 때는 베타가 큰 주식에, 하락장일이 기대될 때는 베타가 낮은 주식에 투자하는 것이 좋습니다.

주식시장에서의 베타는 통계학의 회귀분석모형에서 기울기를 나타내는 베타와 정확히 의미가 같습니다. 회귀분석모형은 $y = a + bx$ 형태로 나타나며, x의 변화에 따른 y의 변화의 기울기가 회귀계수인 b입니다. 이를 주식에 적용한 모형이 자산가격결정모형(CAPM: Capital Asset Pricing Model)이며, 그 식은 다음과 같습니다.

$$회귀분석모형: y = a + bx$$
$$자산가격결정모형: R_i = R_f + \beta_i×[R_m - R_f]$$

먼저 회귀분석모형의 상수항인 a에 해당하는 부분은 무위험 수익률을 나타내는 $R_f$입니다. 독립변수인 x에 해당하는 부분은 무위험 수익률 대비 주식 시장의 초과 수익률을 나태내는 $R_m - R_f$입니다. 종속변수인 y에 해당하는 부분은 개별주식의 수익률을 나타내는 $R_i$이며, 최종적으로 회귀계수인 b에 해당하는 부분은 개별 주식의 베타인 입니다.


Table: (\#tab:unnamed-chunk-4)회귀분석모형과 자산가격결정모형의 비교

구분       회귀분석모형   자산가격결정모형            
---------  -------------  ----------------------------
상수항     a              $R_f$ (무위험 수익률)       
독립변수   x              $R_m - R_f$ (초과 수익률)   
종속변수   y              $R_i$ (개별주식의 수익률    
회귀계수   b              $\beta_i$ (개별주식의 베타) 

통계학에서 회귀계수는 $\beta = \frac{cov(x,y)}{σ_x^2}$ 형태로 구할 수 있으며, x와 y에 각각 시장수익률과 개별주식의 수익률을 대입할 경우 개별주식의 베타는 $\beta_i= ρ(i,m) ×  \frac{σ_i}{σ_m}$  형태로 구할 수 있습니다. 그러나 이러한 수식을 모르더라도 R에서는 간단히 베타를 구할 수 있습니다.

### 베타 계산하기

베타를 구하는 방법을 알아보기 위해 주식시장에 대한 대용치로 KOSPI 200 ETF, 전통적 고베타주인 증권주를 이용하도록 하겠습니다.


```r
library(quantmod)
library(PerformanceAnalytics)
library(magrittr)

symbols = c('102110.KS', '039490.KS')
getSymbols(symbols)
```

```
## [1] "102110.KS" "039490.KS"
```

```r
prices = do.call(cbind, lapply(symbols, function(x) Cl(get(x))))

ret = Return.calculate(prices)
ret = ret['2016-01::2018-12']
```

1. KOSPI 200 ETF인 TIGER 200(102110.KS), 증권주인 키움증권(039490.KS)의 티커를 입력합니다.
2. `getSymbols()` 함수를 이용하여 해당 티커들의 데이터가 다운로드 받습니다.
3. `lapply()` 함수 내에 `Cl()`과 `get()`함수를 사용하여 종가에 해당하는 데이터만 추출하며, 리스트 형태의 데이터를 열의 형태로 묶어주기 위해 `do.call()` 함수와 `cbind()` 함수를 사용해 줍니다.
4. `Return.calculate()` 함수를 통해 수익률을 계산해 줍니다.
5. xts 형식의 데이터는 대괄호 속에 ['시작일자::종료일자']와 같은 형태로, 원하는 날짜를 편리하게 선택할 수 있으며, 위에서는 2016년 1월부터 2018년 12월 까지 데이터를 선택합니다.


```r
rm = ret[, 1]
ri = ret[, 2]

reg = lm(ri ~ rm)
summary(reg)
```

```
## 
## Call:
## lm(formula = ri ~ rm)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.06886 -0.01294 -0.00169  0.01080  0.09545 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(>|t|)    
## (Intercept) 0.0003446  0.0007213   0.478    0.633    
## rm          1.7622492  0.0906194  19.447   <2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.0195 on 729 degrees of freedom
## Multiple R-squared:  0.3416,	Adjusted R-squared:  0.3407 
## F-statistic: 378.2 on 1 and 729 DF,  p-value: < 2.2e-16
```

증권주를 대상으로 베타를 구하기 위한 회귀분석을 실시해 주도록 합니다. 자산가격결정모형의 수식인 $R_i = R_f + \beta_i×[R_m - R_f]$ 에서 편의를 위해 무위험 수익률인 $R_f$를 0으로 가정하면, $R_i = \beta_i×R_m$의 형태로 나타낼 수 있습니다. 이 중 $R_m$는 독립변수인 주식시장의 수익률을, $R_i$는 종속변수인 개별주식의 수익률을 의미합니다.

1. 독립변수는 첫번째 열인 KOSPI 200 ETF의 수익률을 선택해주며, 종속변수는 세번째 열인 증권주의 수익률을 선택해줍니다.
2. `lm()` 함수를 통해 손쉽게 선형회귀분석을 실시할 수 있으며, 회귀분석의 결과를 reg 변수에 저장해줍니다.
3. `summary()` 함수는 데이터의 요약 정보를 나타내며, 해당 예시에서는 회귀분석결과에 대한 정보를 보여줍니다.

회귀분석의 결과 중 가장 중요한 부분은 계수를 나타내는 Coefficients 부분입니다. Intercept 부분은 회귀분석의 상수항에 해당하는 부분으로써, 값이 거의 0에 가깝고 t밸류 또한 매우 작아 유의하지 않음이 보입니다. 우리가 원하는 베타에 해당하는 부분은 x의 Estimate 부분으로써, 베타값이 1.76로 증권주의 특성인 고베타주임이 확인되며, t밸류 또한 19.45로 매우 유의한 결과입니다. 조정된 결정계수(Adjusted R-square)는 0.34를 보입니다.

### 베타 시각화 ###

다음으로 구해진 베타를 그림으로 표현해보도록 하겠습니다.


```r
plot(as.numeric(rm), as.numeric(ri), pch = 4, cex = 0.3, 
     xlab = "KOSPI 200", ylab = "Individual Stock",
     xlim = c(-0.02, 0.02), ylim = c(-0.02, 0.02))
grid()
abline(a = 0, b = 1, lty = 2)
abline(reg, col = 'red')
```

<img src="09-factor_basic_files/figure-html/unnamed-chunk-7-1.png" width="50%" style="display: block; margin: auto;" />

1. `plot()` 함수를 통해 그림을 그려주며, x축과 y축에 주식시장 수익률과 개별주식 수익률을 입력합니다.pch는 점들의 모양을, cex는 점들의 크기를 나타내며, xlab과 ylab은 각각 x축과 y축에 들어갈 문구를 나타냅니다. xlim과 ylim은 x축과 y축의 최소 및 최대 범위를 지정해줍니다.
2. `grid()` 함수를 통해 격자무늬를 추가해줍니다.
3. 첫번째 `abline()`에서 a는 상수, b는 직선의 기울기, lty는 선의 유형을 나타냅니다. 이를 통해 기울기, 즉 베타가 1일 경우의 선을 점선으로 표현합니다.
4. 두번째 `abline()`에 회귀분석 결과를 입력해주면 자동적으로 회귀식을 그려줍니다. 

검은색의 점선이 기울기가 1인 경우이며, 붉은색의 직선이 증권주의 회귀분석결과를 나타냅니다. 기울기가 1보다 훨씬 가파름이 확인되며, 즉 베타가 1보다 크다는 사실을 알 수 있습니다. 

## 저변동성 전략

금융 시장에서 변동성은 수익률이 움직이는 정도로써, 일반적으로 표준편차가 사용됩니다. 표준편차는 자료가 평균을 중심으로 얼마나 퍼져 있는지를 나타내는 수치로써, 수식은 다음과 같습니다.

$$\sigma = \sqrt{\frac{\sum_{i=1}^{n}{(x_i - \bar{x})^2}}{n-1}}$$

관측값의 개수가 작을 경우에는 수식에 대입하여 계산하는 것이 가능하지만, 관측값이 수백 혹은 수천개로 늘어날 경우 컴퓨터를 이용하지 않고 계산하는 것은 사실상 불가능합니다. R에서는 복잡한 계산과정 없이 `sd()` 함수를 이용하여 간단하게 표준편차를 계산할 수 있습니다.


```r
example = c(85, 76, 73, 80, 72)
sd(example)
```

```
## [1] 5.357238
```

개별 주식의 표준편차를 측정할 때는 주식의 가격이 아닌 수익률로 계산해야 합니다. 수익률의 표준편차가 크다는 의미는 수익률의 위 아래로 많이 움직여 위험한 종목으로 여겨집니다. 반면, 표준편차가 작다는 의미는 수익률의 움직임이 적어 상대적으로 안전한 종목으로 여겨집니다.

전통적 금융 이론에서는 수익률의 변동성이 클수록 위험이 크고, 이런 위험에 대한 보상으로 기대수익률이 높아야 한다고 보았습니다. 따라서 고변동성 종목의 기대수익률이 크고, 저변동성 종목의 기대수익률이 낮은 고위험 고수익이 당연한 믿음이었습니다. 그러나 현실에서는 오히려 변동성이 낮은 종목들의 수익률이 변동성이 높은 종목들의 수익률 보다 높은, 저변동성 효과가 발견되고 있습니다. 이러한 저변동성 효과가 발생하는 원인으로는 여러 가설이 있습니다.

1. 투자자들은 대체로 자신의 능력을 과신하는 경향이 있으며, 복권과 같이 큰 수익을 가져다 주는 고변동성 주식을 선호하는 경향이 있습니다. 이러한 결과로 고변동성 주식은 과대 평가가 되어 수익률이 낮은 반면, 과소 평가된 저변동성 주식들은 높은 수익률을 보이게 됩니다.
2. 대부분 기관투자가들이 레버리지 투자가 되지 않는 상황에서, 벤치마크 대비 높은 성과를 얻기 위해 고변동성 주식에 투자하는 경향이 있으며, 이 또한 고변동성 주식이 과대 평가되는 결과로 이어집니다.
3. 시장의 상승과 하락이 반복됨에 따라 고변동성 주식이 변동성 손실(Volatility Drag)로 인해 수익률이 하락하게 되는 이유도 있습니다.

주식의 위험은 변동성뿐만 아니라 베타 등 여러 지표로도 측정할 수 있습니다. 저변동성 효과와 비슷하게 고유변동성이 낮은 주식의 수익률이 높은 저고유변동성 효과, 베타가 낮은 주식의 수익률이 오히려 높은 저베타 효과도 발견되고 있으며, 이러한 효과들을 합쳐 저위험 효과로 부르기도 합니다.

### 저변동성 포트폴리오 구하기: 일간 기준

먼저 최근 1년 일간 수익률 기준 변동성이 낮은 30종목을 선택하도록 하겠습니다.


```r
library(stringr)
library(xts)
library(PerformanceAnalytics)
library(magrittr)
library(ggplot2)
library(dplyr)

KOR_price = read.csv('data/KOR_price.csv', row.names = 1, stringsAsFactors = FALSE) %>% as.xts()
KOR_ticker = read.csv('data/KOR_ticker.csv', row.names = 1, stringsAsFactors = FALSE) 
KOR_ticker$'종목코드' = str_pad(KOR_ticker$'종목코드', 6, 'left', 0)

ret = Return.calculate(KOR_price)
std_12m_daily = xts::last(ret, 252) %>% apply(., 2, sd) %>% multiply_by(sqrt(252))
```

1. 먼저 미리 저장해둔 가격 정보와 티커 정보를 불러오도록 하며, 가격 정보의 경우 `as.xts()` 함수를 통해 xts 형태로 변경해주도록 합니다.
2. `Return.calculate()` 함수를 통해 수익률을 구하도록 합니다.
3. `last()` 함수는 마지막 n개를 선택해주는 함수이며, 1년 영업일 기준인 252개 데이터를 선택합니다. `dplyr` 패키지의 last() 함수와 변수명이 같으므로, `xts::last()` 형식을 통해 xts 패키지의 함수임을 정의해줍니다.
4. `apply()` 함수를 sd 즉 변동성을 계산해주며, 연율화를 해주기 위해 `multiply_by()` 함수를 통해 $\sqrt{252}$를 곱해주도록 합니다.


```r
std_12m_daily %>% 
  data.frame() %>%
  ggplot(aes(x = (`.`))) +
  geom_histogram(binwidth = 0.01) +
  annotate("rect", xmin = -0.02, xmax = 0.02,
           ymin = 0, ymax = sum(std_12m_daily == 0, na.rm = TRUE) * 1.1,
           alpha=0.3, fill="red") +
  xlab(NULL)
```

```
## Warning: Removed 78 rows containing non-finite values (stat_bin).
```

<img src="09-factor_basic_files/figure-html/unnamed-chunk-10-1.png" width="50%" style="display: block; margin: auto;" />

```r
std_12m_daily[std_12m_daily == 0] = NA
```

변동성을 히스토그램으로 나타내보면, 0에 위치하는 종목들이 다수 존재합니다. 해당 종목들은 최근 1년간 거래정지로 인해 가격이 변하지 않았고, 이로 인해 변동성이 없는 종목들이며, 해당 종믁들은 NA로 처리해주도록 합니다.


```r
std_12m_daily[rank(std_12m_daily) <= 30]
```

```
##    X030200    X023890    X001720    X019680    X015350    X017390 
## 0.15883357 0.17800927 0.14979776 0.17028914 0.12856393 0.16774637 
##    X034950    X015360    X092230    X018120    X092130    X006220 
## 0.13703389 0.11761867 0.13595720 0.10462883 0.14315399 0.16126738 
##    X117580    X003460    X003650    X034590    X007330    X023000 
## 0.11310507 0.10016896 0.16767103 0.05205645 0.14683316 0.16223926 
##    X040420    X000650    X003080    X004450    X001750    X006660 
## 0.11583847 0.16608842 0.13828583 0.14381323 0.13202788 0.16935610 
##    X014440    X084670    X115310    X066670    X025530    X066790 
## 0.17695655 0.17286665 0.15732413 0.16074442 0.17418725 0.10923847
```

```r
std_12m_daily[rank(std_12m_daily) <= 30] %>%
  data.frame() %>%
  ggplot(aes(x = rep(1:30), y = `.`)) +
  geom_col() +
  xlab(NULL)
```

<img src="09-factor_basic_files/figure-html/unnamed-chunk-11-1.png" width="40%" style="display: block; margin: auto;" />

`rank()` 함수를 통해 순위를 구할 수 있으며, R은 기본적으로 오름차순 즉 가장 낮은 값의 순위가 1이 됩니다. 따라서 변동성이 낮을수록 높은 순위가 되며, 30위 이하의 순위를 선택하면 변동성이 낮은 30종목이 선택됩니다. 또한 `ggplot()` 함수를 이용해 해당 종목들의 변동성을 확인해볼 수도 있습니다.

이번에는 해당 종목들의 티커 및 종목명을 확인하도록 하겠습니다.


```r
invest_lowvol = rank(std_12m_daily) <= 30
KOR_ticker[invest_lowvol, ] %>%
  select(`종목코드`, `종목명`) %>%
  mutate(`변동성` = std_12m_daily[invest_lowvol])
```

```
##    종목코드             종목명     변동성
## 1    030200                 KT 0.15883357
## 2    023890 한국아트라스비엑스 0.17800927
## 3    001720           신영증권 0.14979776
## 4    019680               대교 0.17028914
## 5    015350           부산가스 0.12856393
## 6    017390           서울가스 0.16774637
## 7    034950       한국기업평가 0.13703389
## 8    015360       예스코홀딩스 0.11761867
## 9    092230          KPX홀딩스 0.13595720
## 10   018120           진로발효 0.10462883
## 11   092130         이크레더블 0.14315399
## 12   006220           제주은행 0.16126738
## 13   117580         대성에너지 0.11310507
## 14   003460           유화증권 0.10016896
## 15   003650           미창석유 0.16767103
## 16   034590       인천도시가스 0.05205645
## 17   007330       푸른저축은행 0.14683316
## 18   023000           삼원강재 0.16223926
## 19   040420     정상제이엘에스 0.11583847
## 20   000650           천일고속 0.16608842
## 21   003080           성보화학 0.13828583
## 22   004450           삼화왕관 0.14381323
## 23   001750           한양증권 0.13202788
## 24   006660           삼성공조 0.16935610
## 25   014440           영보화학 0.17695655
## 26   084670           동양고속 0.17286665
## 27   115310           인포바인 0.15732413
## 28   066670       디스플레이텍 0.16074442
## 29   025530          SJM홀딩스 0.17418725
## 30   066790           씨씨에스 0.10923847
```

티커와 종목명, 그리고 연율화 변동성을 확인할 수 있습니다.

### 저변동성 포트폴리오 구하기: 주간 기준

이번에는 일간 변동성이 아닌 주간 변동성을 기준으로 저변동성 종목을 선택하도록 하겠습니다.


```r
std_12m_weekly = xts::last(ret, 252) %>%
  apply.weekly(Return.cumulative) %>%
  apply(., 2, sd) %>% multiply_by(sqrt(52))

std_12m_weekly[std_12m_weekly == 0] = NA
```

먼저 최근 252일 수익률울 선택한 후, `apply.weekly()` 함수 내 Return.cumulative를 입력하여 주간 수익률을 계산해주도록 합니다. 이 외에도 `apply.monthly()`, `apply.yearly()` 함수 등으로 일간 수익률을 월간, 연간 수익률 등으로 변환할 수 있습니다. 그 후 과정은 위와 동일합니다.



```r
std_12m_weekly[rank(std_12m_weekly) <= 30]
```

```
##    X316140    X030200    X001720    X019680    X002960    X015350 
## 0.15274966 0.15157981 0.11649582 0.15019451 0.14310423 0.12891254 
##    X017390    X034950    X015360    X092230    X018120    X092130 
## 0.15177890 0.12661257 0.09841187 0.11667602 0.07697824 0.14996425 
##    X117580    X003460    X024090    X003650    X305090    X034590 
## 0.12276231 0.08209505 0.16098784 0.14017809 0.13359121 0.03664249 
##    X007330    X040420    X003080    X004450    X001750    X009770 
## 0.14765696 0.11081823 0.16192733 0.11347859 0.12755502 0.16684754 
##    X115310    X066670    X049430    X033200    X002070    X066790 
## 0.12689543 0.14418311 0.14696084 0.16152329 0.15739877 0.15243463
```

```r
invest_lowvol_weekly = rank(std_12m_weekly) <= 30
KOR_ticker[invest_lowvol_weekly, ] %>%
  select(`종목코드`, `종목명`) %>%
  mutate(`변동성` = std_12m_weekly[invest_lowvol_weekly])
```

```
##    종목코드         종목명     변동성
## 1    316140   우리금융지주 0.15274966
## 2    030200             KT 0.15157981
## 3    001720       신영증권 0.11649582
## 4    019680           대교 0.15019451
## 5    002960     한국쉘석유 0.14310423
## 6    015350       부산가스 0.12891254
## 7    017390       서울가스 0.15177890
## 8    034950   한국기업평가 0.12661257
## 9    015360   예스코홀딩스 0.09841187
## 10   092230      KPX홀딩스 0.11667602
## 11   018120       진로발효 0.07697824
## 12   092130     이크레더블 0.14996425
## 13   117580     대성에너지 0.12276231
## 14   003460       유화증권 0.08209505
## 15   024090         디씨엠 0.16098784
## 16   003650       미창석유 0.14017809
## 17   305090 마이크로디지탈 0.13359121
## 18   034590   인천도시가스 0.03664249
## 19   007330   푸른저축은행 0.14765696
## 20   040420 정상제이엘에스 0.11081823
## 21   003080       성보화학 0.16192733
## 22   004450       삼화왕관 0.11347859
## 23   001750       한양증권 0.12755502
## 24   009770       삼정펄프 0.16684754
## 25   115310       인포바인 0.12689543
## 26   066670   디스플레이텍 0.14418311
## 27   049430         코메론 0.14696084
## 28   033200         모아텍 0.16152329
## 29   002070     남영비비안 0.15739877
## 30   066790       씨씨에스 0.15243463
```

주간 수익률의 변동성이 낮은 30종목을 선택하여 종목코드, 종목명, 연율화 변동성을 확인하도록 합니다.



```r
intersect(KOR_ticker[invest_lowvol, '종목명'], KOR_ticker[invest_lowvol_weekly, '종목명'])
```

```
##  [1] "KT"             "신영증권"       "대교"           "부산가스"      
##  [5] "서울가스"       "한국기업평가"   "예스코홀딩스"   "KPX홀딩스"     
##  [9] "진로발효"       "이크레더블"     "대성에너지"     "유화증권"      
## [13] "미창석유"       "인천도시가스"   "푸른저축은행"   "정상제이엘에스"
## [17] "성보화학"       "삼화왕관"       "한양증권"       "인포바인"      
## [21] "디스플레이텍"   "씨씨에스"
```

`intersect()` 함수를 통해 일간 변동성 기준과 주간 변동성 기준 모두에 포함되는 종목을 찾을 수 있습니다.

## 모멘텀 전략

투자에서 모멘텀이란 주가 혹은 이익의 추세로써, 상승 추세의 주식은 지속적으로 상승하며 하락 추세의 주식은 지속적으로 하락하는 현상을 말합니다. 모멘텀 현상이 발생하는 원인 중 가장 큰 이유는 투자자들의 스스로에 대한 과잉 신뢰 때문입니다. 사람들은 자신의 판단을 지지하는 정보에 대해서는 과잉 반응하는, 자신의 판단을 부정하는 정보에 대해서는 과소 반응하는 경향이 있습니다. 이러한 투자자들의 비합리성으로 인해 모멘텀 현상이 생겨나게 됩니다.

모멘텀의 종류는 크게 기업의 이익에 대한 추세를 나타내는 이익 모멘텀과, 주가의 모멘텀에 대한 가격 모멘텀이 있습니다. 또한 가격 모멘텀도 1주일 혹은 1개월 이하를 의미하는 단기 모멘텀, 3개월에서 12개월을 의미하는 중기 모멘텀, 3년에서 5년을 의미하는 장기 모멘텀이 있으며, 이중에서도 3개월에서 12개월 가격 모멘텀을 흔히 모멘텀이라 합니다.

### 모멘텀 포트폴리오 구하기: 12개월 모멘텀

먼저 최근 1년 동안의 수익률이 높은 30 종목을 선택하도록 하겠습니다.


```r
library(stringr)
library(xts)
library(PerformanceAnalytics)
library(magrittr)
library(dplyr)

KOR_price = read.csv('data/KOR_price.csv', row.names = 1, stringsAsFactors = FALSE) %>% as.xts()
KOR_ticker = read.csv('data/KOR_ticker.csv', row.names = 1, stringsAsFactors = FALSE) 
KOR_ticker$'종목코드' = str_pad(KOR_ticker$'종목코드', 6, 'left', 0)

ret = Return.calculate(KOR_price) %>% xts::last(252) 
ret_12m = ret %>% sapply(., function(x) {
  prod(1+x) - 1
  })
```

1. 가격 정보와 티커 정보를 불러온 후, `Return.calculate()` 함수를 통해 수익률을 계산합니다. 그 후, 최근 252일 수익률을 선택합니다.
2. `sapply()` 함수 내부에 `prod()` 함수를 이용하여 각 종목의 누적수익률을 계산해줍니다.


```r
ret_12m[rank(-ret_12m) <= 30]
```

```
##  X081660  X032500  X091700  X078070  X214150  X230360  X033640  X048410 
## 1.877551 1.960089 1.294118 8.245283 1.480620 2.700935 1.760000 2.258427 
##  X239610  X008350  X138080  X047310  X078130  X179900  X143160  X263920 
## 2.353383 2.022472 4.230047 1.718053 2.144068 1.781100 2.451327 2.270440 
##  X238090  X009460  X176440  X033110  X263540  X190510  X215090  X100030 
## 1.324195 2.146667 2.887399 1.420690 3.646465 1.500000 1.208861 2.211982 
##  X051160  X174880  X119830  X024060  X139670  X033250 
## 3.710526 1.298077 1.428811 1.417657 2.359274 1.188000
```

`rank()` 함수를 통해 순위를 구하도록 하며, 모멘텀의 경우 높을수록 좋은 내림차순으로 순위를 계산해야 하므로 수익률 앞에 마이너스(-)를 붙여주도록 합니다. 12개월 누적수익률이 높은 종목들이 선택됨이 확인됩니다.


```r
invest_mom = rank(-ret_12m) <= 30
KOR_ticker[invest_mom, ] %>%
  select(`종목코드`, `종목명`) %>%
  mutate(`수익률` = ret_12m[invest_mom])
```

```
##    종목코드           종목명   수익률
## 1    081660       휠라코리아 1.877551
## 2    032500     케이엠더블유 1.960089
## 3    091700           파트론 1.294118
## 4    078070   유비쿼스홀딩스 8.245283
## 5    214150         클래시스 1.480620
## 6    230360       에코마케팅 2.700935
## 7    033640           네패스 1.760000
## 8    048410       현대바이오 2.258427
## 9    239610 에이치엘사이언스 2.353383
## 10   008350       남선알미늄 2.022472
## 11   138080       오이솔루션 4.230047
## 12   047310       파워로직스 1.718053
## 13   078130         국일제지 2.144068
## 14   179900         유티아이 1.781100
## 15   143160         아이디스 2.451327
## 16   263920     블러썸엠앤씨 2.270440
## 17   238090         앤디포스 1.324195
## 18   009460         한창제지 2.146667
## 19   176440       에이치엔티 2.887399
## 20   033110 코너스톤네트웍스 1.420690
## 21   263540             샘코 3.646465
## 22   190510           나무가 1.500000
## 23   215090     한컴유니맥스 1.208861
## 24   100030       모바일리더 2.211982
## 25   051160       지어소프트 3.710526
## 26   174880         장원테크 1.298077
## 27   119830           아이텍 1.428811
## 28   024060         흥구석유 1.417657
## 29   139670       키네마스터 2.359274
## 30   033250           체시스 1.188000
```

티커와 종목명, 그리고 누적수익률을 확인할 수 있습니다.

### 모멘텀 포트폴리오 구하기: 위험조정 수익률

투자성과 평가시 단순 수익률 보다는 위험이 함께 고려된 위험조정 수익률을 사용하는 것이 일반적이며, 대표적으로 샤프지수가 사용됩니다. 모멘텀 측정 역시 단순 12개월 누적수익률을 사용하기 보다 변동성이 함께 고려된 지표를 사용할 수 있습니다. 이는 누적 수익률을 변동성으로 나누어 계산할 수 있습니다.


```r
ret = Return.calculate(KOR_price) %>% xts::last(252) 
ret_12m = ret %>% sapply(., function(x) {
  prod(1+x) - 1
  })
std_12m = ret %>% apply(., 2, sd) %>% multiply_by(sqrt(252))
sharpe_12m = ret_12m / std_12m
```

1. 최근 1년에 해당하는 수익률을 선택합니다.
2. `sapply()`와 `prod()` 함수를 이용해 분자에 해당하는 누적수익률을 계산합니다.
3. `apply()`와 `multiply_by()` 함수를 이용해 분모에 해당하는 연율화 변동성을 계산합니다.
4. 수익률을 변동성으로 나누어 위험조정 수익률을 계산해줍니다.

이를 통해 수익률이 높으면서 변동성이 낮은 종목을 선정할 수 있습니다.


```r
invest_mom_sharpe = rank(-sharpe_12m) <= 30
KOR_ticker[invest_mom_sharpe, ] %>%
  select(`종목코드`, `종목명`) %>%
  mutate(`수익률` = ret_12m[invest_mom_sharpe],
         `변동성` = std_12m[invest_mom_sharpe],
         `샤프지수` = sharpe_12m[invest_mom_sharpe])
```

```
##    종목코드             종목명    수익률    변동성  샤프지수
## 1    081660         휠라코리아 1.8775510 0.4926982  3.810752
## 2    032500       케이엠더블유 1.9600887 0.5845094  3.353392
## 3    091700             파트론 1.2941176 0.3983947  3.248331
## 4    078070     유비쿼스홀딩스 8.2452830 0.6287894 13.112948
## 5    214150           클래시스 1.4806202 0.6330597  2.338832
## 6    230360         에코마케팅 2.7009346 0.6334375  4.263933
## 7    033640             네패스 1.7600000 0.6828009  2.577618
## 8    001630       종근당홀딩스 0.8424855 0.3043580  2.768074
## 9    023890 한국아트라스비엑스 0.4400848 0.1780093  2.472258
## 10   048410         현대바이오 2.2584270 0.9816231  2.300707
## 11   239610   에이치엘사이언스 2.3533835 0.6101647  3.856965
## 12   008350         남선알미늄 2.0224719 0.7698214  2.627196
## 13   138080         오이솔루션 4.2300469 0.6140487  6.888780
## 14   047310         파워로직스 1.7180527 0.5963754  2.880824
## 15   215000             골프존 0.7087156 0.3005854  2.357785
## 16   078130           국일제지 2.1440678 0.9156255  2.341643
## 17   123860           아나패스 1.1775148 0.4571479  2.575785
## 18   179900           유티아이 1.7811005 0.7756217  2.296352
## 19   143160           아이디스 2.4513274 0.8459942  2.897570
## 20   263920       블러썸엠앤씨 2.2704403 0.8233114  2.757693
## 21   068930         디지털대성 1.1031579 0.4487269  2.458417
## 22   009460           한창제지 2.1466667 0.7756701  2.767499
## 23   176440         에이치엔티 2.8873995 0.8561663  3.372475
## 24   002170           삼양통상 0.6674260 0.2846687  2.344571
## 25   263540               샘코 3.6464646 0.6825631  5.342311
## 26   190510             나무가 1.5000000 0.4572728  3.280317
## 27   100030         모바일리더 2.2119816 0.6426339  3.442055
## 28   051160         지어소프트 3.7105263 0.8189892  4.530617
## 29   104460       동양피엔에프 1.1615385 0.4325680  2.685216
## 30   139670         키네마스터 2.3592737 0.7857814  3.002456
```

티커와 종목명, 누적수익률, 변동성, 샤프지수를 확인할 수 있습니다.


```r
intersect(KOR_ticker[invest_mom, '종목명'], KOR_ticker[invest_mom_sharpe, '종목명'])
```

```
##  [1] "휠라코리아"       "케이엠더블유"     "파트론"          
##  [4] "유비쿼스홀딩스"   "클래시스"         "에코마케팅"      
##  [7] "네패스"           "현대바이오"       "에이치엘사이언스"
## [10] "남선알미늄"       "오이솔루션"       "파워로직스"      
## [13] "국일제지"         "유티아이"         "아이디스"        
## [16] "블러썸엠앤씨"     "한창제지"         "에이치엔티"      
## [19] "샘코"             "나무가"           "모바일리더"      
## [22] "지어소프트"       "키네마스터"
```

`intersect()` 함수를 통해 단순 수익률 및 위험조정 수익률 기준 모두에 포함되는 종목을 찾을 수 있습니다. 다음 그림은 위험조정 수익률 상위 30 종목의 가격 그래프입니다.


```r
library(xts)
library(tidyr)
library(ggplot2)

KOR_price[, invest_mom_sharpe] %>%
  fortify.zoo() %>%
  gather(ticker, price, -Index) %>%
  ggplot(aes(x = Index, y = price)) +
  geom_line() +
  facet_wrap(. ~ ticker, scales = 'free') +
  xlab(NULL) +
  ylab(NULL) +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank())
```

<img src="09-factor_basic_files/figure-html/unnamed-chunk-22-1.png" width="672" style="display: block; margin: auto;" />

## 밸류 전략

가치주 효과란 내재 가치 대비 낮은 가격의 주식(저 PER, 저 PBR 등)이, 내재 가치 대비 비싼 주식보다 수익률이 높은 현상을 뜻합니다. 가치 효과가 발생하는 원인에 대한 이론은 다음가 같습니다.

1. 위험한 기업은 시장에서 상대적으로 낮은 가격에 거래되며, 이러한 위험을 감당하는 대가로 수익이 발생
2. 투자자들의 성장주에 대한 과잉 반응으로 인해 가치주는 시장에서 소외되며, 제자리를 찾아가는 과정에서 수익이 발생

가치를 나타내는 지표는 굉장히 많지만, 일반적으로 PER, PBR, PCR, PSR가 많이 사용됩니다.

### 밸류 포트폴리오 구하기: 저 PBR 

먼저 기업의 가치 여부를 판단할 때 가장 많이 사용되는 지표인 PBR을 이용한 포트폴리오를 구성하도록 하겠습니다.


```r
library(stringr)
library(ggplot2)
library(dplyr)

KOR_value = read.csv('data/KOR_value.csv', row.names = 1, stringsAsFactors = FALSE)
KOR_ticker = read.csv('data/KOR_ticker.csv', row.names = 1, stringsAsFactors = FALSE) 
KOR_ticker$'종목코드' = str_pad(KOR_ticker$'종목코드', 6, 'left', 0)

invest_pbr = rank(KOR_value$PBR) <= 30
KOR_ticker[invest_pbr, ] %>%
  select(`종목코드`, `종목명`) %>%
  mutate(`PBR` = KOR_value[invest_pbr, 'PBR'])
```

```
##    종목코드           종목명        PBR
## 1    015760         한국전력 0.22890911
## 2    000880             한화 0.11606599
## 3    034020       두산중공업 0.20544967
## 4    006120     SK디스커버리 0.20650481
## 5    032190       다우데이타 0.14267200
## 6    058650       세아홀딩스 0.12103881
## 7    005720             넥센 0.18200630
## 8    003300       한일홀딩스 0.18593347
## 9    001940      KISCO홀딩스 0.20079881
## 10   092230        KPX홀딩스 0.21762987
## 11   002030           아세아 0.17733393
## 12   003030     세아제강지주 0.16810363
## 13   036530        S&T홀딩스 0.15183556
## 14   000140 하이트진로홀딩스 0.19737822
## 15   033160       엠케이전자 0.22069751
## 16   035080   인터파크홀딩스 0.19322603
## 17   009200       무림페이퍼 0.19913383
## 18   042420   네오위즈홀딩스 0.23330114
## 19   007860             서연 0.10661426
## 20   002300         한국제지 0.18877865
## 21   005010           휴스틸 0.21588468
## 22   040610             SG&G 0.11514814
## 23   031980 피에스케이홀딩스 0.20475027
## 24   025530        SJM홀딩스 0.20175300
## 25   006200   한국전자홀딩스 0.14141955
## 26   000950             전방 0.23116800
## 27   037400         우리조명 0.17634443
## 28   194510       파티게임즈 0.20834533
## 29   192410           감마누 0.21648539
## 30   149940             모다 0.05385654
```

먼저 가치 지표들을 저장한 데이터와 티커 데이터를 불러오도록 하며, `rank()`를 통해 PBR이 낮은 30 종목을 선택해주도록 합니다. 그 후 종목코드와 종목명, PBR을 확인해보도록 합니다. 많은 홀딩스 등 지주사가 특성상 저PBR 포트폴리오에 많이 구성되어 있습니다.

### 각 지표를 결합하기

저PBR 하나의 지표만으로도 우수한 성과를 거둘 수 있음은 오랜 기간동안 증명되고 있습니다. 그러나 저평가 주식이 계속해서 저평가에 머무르는 가치 함정에 빠지지 않기 위해서는, 여러 지표를 동시에 볼 필요도 있습니다.


```r
rank_value = KOR_value %>% 
  mutate_all(funs(min_rank(.)))
```

```
## Warning: funs() is soft deprecated as of dplyr 0.8.0
## please use list() instead
## 
## # Before:
## funs(name = f(.)
## 
## # After: 
## list(name = ~f(.))
## This warning is displayed once per session.
```

```r
cor(rank_value, use = 'complete.obs') %>%
  round(., 2) %>%
  data.frame(ID = rownames(.)) %>%
  gather(index, value, -ID) %>%
  ggplot(aes(x = ID, y = index, fill = value)) +
  geom_tile(color = 'white') +
  scale_fill_gradient2(low = 'blue', high = 'red', mid = 'white',
                       midpoint = 0, limit = c(-1, 1), space = 'Lab', name = 'Correlation') +
  theme_minimal() +
  xlab(NULL) + ylab(NULL) +
  geom_text(aes(x = ID, y = index, label = value), color = 'black', size = 4)
```

<img src="09-factor_basic_files/figure-html/unnamed-chunk-24-1.png" width="50%" style="display: block; margin: auto;" />

먼저 `mutate_all()` 함수를 이용해 모든 열에 함수를 적용해주며, `min_rank()`를 통해 순위를 구해주도록 합니다.

각 열에 해당하는 가치 지표 별 랭킹을 구해준 후 상관관계를 확인해보도록 하며, NA 종목은 삭제해주기 위해 `use = 'complete.obs'`를 입력해주도록 합니다. 같은 가치 지표임에도 불구하고 서로간의 상관관계가 꽤 낮은 지표도 존재하여, 지표를 통합적으로 고려시 분산효과를 기대할 수도 있습니다.


```r
rank_sum = rank_value %>%
  rowSums()

invest_value = rank(rank_sum) <= 30

KOR_ticker[invest_value, ] %>%
  select(`종목코드`, `종목명`) %>%
  cbind(KOR_value[invest_value, ])
```

```
##      종목코드           종목명        PER       PBR       PCR        PSR
## 15     034730               SK  7.4635440 0.3304540 2.1404074 0.16567271
## 87     001040               CJ 10.8317359 0.2388349 1.9405894 0.10129735
## 114    000880             한화  4.2008258 0.1160660 0.7157234 0.04037051
## 150    042670   두산인프라코어  5.4405789 0.3508581 1.6000939 0.17342061
## 274    006840         AK홀딩스  5.8120731 0.4215419 1.9581173 0.16741502
## 408    017940               E1  4.9100384 0.2914158 2.0761992 0.08282018
## 440    058650       세아홀딩스 11.0975610 0.1210388 2.5870647 0.07031235
## 458    005720             넥센  5.5093481 0.1820063 2.5271494 0.25197166
## 478    015750       성우하이텍 14.2222222 0.2701055 1.2757475 0.09997397
## 497    003300       한일홀딩스  0.6267306 0.1859335 2.5311606 0.27024357
## 555    084690       대상홀딩스 11.6034218 0.2490687 1.9108648 0.08024733
## 598    002030           아세아  4.8980976 0.1773339 1.0349839 0.15077088
## 604    013580         계룡건설  2.6532403 0.5381288 2.2734778 0.10322721
## 638    003030     세아제강지주  0.7186377 0.1681036 1.7833488 0.12761799
## 645    036530        S&T홀딩스  8.3304527 0.1518356 1.7707867 0.16288761
## 733    005990       매일홀딩스  7.4802563 0.3681428 2.6170594 0.12744735
## 796    005960         동부건설  2.2599994 0.4614920 2.8355510 0.18594294
## 900    267290     경동도시가스  4.1844914 0.4452142 1.1821968 0.08882114
## 947    005710         대원산업  4.6706861 0.4753578 1.9885800 0.18830169
## 960    009200       무림페이퍼  3.8311742 0.1991338 1.5548742 0.11986453
## 981    016710       대성홀딩스  6.5430467 0.2395595 2.2622236 0.14023896
## 1083   036000           예림당  7.4597936 0.3057456 3.3767705 0.14996038
## 1180   003480 한진중공업홀딩스 11.2213286 0.2751824 1.7655937 0.10675683
## 1295   005010           휴스틸  5.0958827 0.2158847 0.7695275 0.14886070
## 1318   037350       성도이엔지  5.6355000 0.4457458 1.7427048 0.16399603
## 1350   002200         수출포장  4.9248555 0.3672414 2.0285714 0.30406852
## 1513   037330     인지디스플레  7.2892757 0.4026053 3.5694907 0.13461920
## 1584   004140             동방  4.0902385 0.4806502 2.1958123 0.11888421
## 1735   031980 피에스케이홀딩스  1.0394425 0.2047503 1.3400042 0.16918215
## 1867   012620         원일특강  5.9432836 0.3666667 4.2361702 0.15560766
```

`rowSums()` 함수를 이용해 종목 별 랭킹들의 합을 구해주도록 합니다. 그 후 4개 지표 랭킹의 합 기준 랭킹이 낮은 30 종목을 선택해 줍니다. 즉 하나의 지표 보다 4개 지표가 골고루 낮은 종목을 선택하여 줍니다. 해당 종목들의 티커, 종목명과 가치 지표들을 확인할 수 있습니다.



```r
intersect(KOR_ticker[invest_pbr, '종목명'], KOR_ticker[invest_value, '종목명'])
```

```
##  [1] "한화"             "세아홀딩스"       "넥센"            
##  [4] "한일홀딩스"       "아세아"           "세아제강지주"    
##  [7] "S&T홀딩스"        "무림페이퍼"       "휴스틸"          
## [10] "피에스케이홀딩스"
```

단순 PBR 기준 선택된 종목과 비교해봤을 때, 겹치는 종목이 상당히 줄어 들었습니다.

## 퀄리티 전략

기업의 우량성, 즉 퀄리티는 투자자들이 가장 중요하게 생각하는 요소입니다. 그러나 어떠한 지표가 기업의 퀄리티를 나타내는지 한마디로 정의하기에는 너무나 주관적이고 광범위하여, 쉽지만은 않습니다. 학계 혹은 업계에서 사용되는 우량성 관련 지표는 다음과 같이 요약할 수 있습니다.

1. Profitability (수익성)
2. Earnings stability (수익의 안정성)
3. Capital structure (기업 구조)
4. Growth (수익의 성장성)
5. Accounting quality (회계적 우량성)
6. Payout/dilution (배당) 
7. Investment (투자)

퀄리티 전략에는 주가 보다는 재무제표 데이터가 많이 사용됩니다.

### F-Score

F-Score 지표는 조셉 피오트로스키 교수가 발표한 지표입니다. 그는 논문에서, 저 PBR을 이용한 밸류 전략은 높은 성과를 기록하지만 재무 상태가 불량한 기업이 많으며, 저 PBR 종목 중 재무적으로 우량한 기업을 선정하여 투자한다면 성과를 훨씬 개선할 수 있다고 보았습니다.

F-Score에서는 재무적 우량 정도를 수익성(Profitability), 재무 성과(Financial Performance), 운영 효율성(Operating Efficiency)으로 구분하여 총 9개의 지표를 선정합니다. 표 \@ref(tab:fscore)는 이를 요약한 테이블입니다.


Table: (\#tab:fscore)F-Score 요약

지표          항목              점수                          
------------  ----------------  ------------------------------
수익성        $ROA$             ROA가 양수면 1점              
수익성        $CFO$             CFO가 양수면 1점              
수익성        $\Delta ROA$      ROA가 증가했으면 1점          
수익성        $ACCRUAL$         CFO > ROA면 1점               
재무성과      $\Delta LEVER$    레버리지가 감소했으면 1점     
재무성과      $\Delta LIQUID$   유동성이 증가했으면 1점       
재무성과      $EQ\_OFFER$       발행주식수가 감소했으면 1점   
운영 효율성   $\Delta MARGIN$   매출총이익률이 증가했으면 1점 
운영 효율성   $\Delta TURN$     회전율이 증가했으면 1점       

각 지표가 우수할 경우 1점, 그렇지 않을 경우 0점을 매겨, 총 0점부터 9점까지의 포트폴리오를 구성합니다. 

$$ F\_SCORE = F\_ROA + F\_\Delta ROA + F\_CFO + F\_ACCRUAL + F\_\Delta MARGIN + \\
F\_ \Delta TURN + F\_\Delta LEVER + F\_\Delta LIQUID + F\_EQ\_OFFER $$


```r
library(stringr)
library(ggplot2)
library(dplyr)

KOR_fs = readRDS('data/KOR_fs.Rds')
KOR_ticker = read.csv('data/KOR_ticker.csv', row.names = 1, stringsAsFactors = FALSE) 
KOR_ticker$'종목코드' = str_pad(KOR_ticker$'종목코드', 6, 'left', 0)
```

먼저 재무제표와 티커 파일을 불러오도록 합니다. 재무제표 데이터의 경우 RdS 형태로 저장되어 있으며, `readRDS()` 함수를 이용해 list 형태 그래도 불러올 수 있습니다.


```r
# 수익성
ROA = KOR_fs$'지배주주순이익' / KOR_fs$'자산'
CFO = KOR_fs$'영업활동으로인한현금흐름' / KOR_fs$'자산'
ACCURUAL = CFO - ROA

# 재무성과
LEV = KOR_fs$'장기차입금' / KOR_fs$'자산'
LIQ = KOR_fs$'유동자산' / KOR_fs$'유동부채'
OFFER = KOR_fs$'유상증자'

# 운영 효율성
MARGIN = KOR_fs$'매출총이익' / KOR_fs$'매출액'
TURN = KOR_fs$'매출액' / KOR_fs$'자산'
```

먼저 지표에 해당하는 내용을 계산해줍니다.

1. ROA는 지배주주순이익을 자산으로 나누어 계산합니다.
2. CFO는 영업활동현금흐름을 자산으로 나누어 계산합니다.
3. ACCURUAL은 CFO와 ROA의 차이를 이용해 계산합니다.
4. Leverage는 장기차입금을 자산으로 나누어 계산합니다.
5. Liquidity는 유동자산을 유동부채로 나누어 계산합니다.
6. 우리가 받은 데이터에서는 발행주식수 데이터를 구할수 없으므로, Offer에 대한 대용치로 유상증자 여부를 사용합니다.
7. Margin은 매출총이익을 매출액으로 나누어 계산합니다.
8. Turnover는 매출액을 자산으로 나누어 계산합니다.

다음으로는 각 지표들이 조건을 충족하는지 여부를 판단하여, 지표별로 1점 혹은 0점을 부여해줍니다.


```r
num_col = ncol(KOR_fs[[1]])

F_1 = as.integer(ROA[, num_col] > 0)
F_2 = as.integer(CFO[, num_col] > 0)
F_3 = as.integer(ROA[, num_col] - ROA[, (num_col-1)] > 0)
F_4 = as.integer(ACCURUAL[,num_col] > 0) 
F_5 = as.integer(LEV[, num_col] - LEV[, (num_col-1)] <= 0) 
F_6 = as.integer(LIQ[, num_col] - LIQ[, (num_col-1)] > 0)
F_7 = as.integer(is.na(OFFER[,num_col]) |
                   OFFER[,num_col] <= 0)
F_8 = as.integer(MARGIN[, num_col] - MARGIN[, (num_col-1)] > 0)
F_9 = as.integer(TURN[,num_col] - TURN[,(num_col-1)] > 0)
```

먼저 `ncol()` 함수를 이용해 열 갯수를 구해줍니다. 가장 최근 연도의 재무제표가 최우측에 위치하고 있으므로, 해당 변수를 통해 최근 연도 데이터만을 선택할 수 있습니다.

`as.integer()` 함수는 TRUE일 경우 1, FALSE 일 경우 0을 반환하는 함수로써, F-Score 지표의 점수를 매기는데 매우 유용합니다. 점수 기준은 다음과 같습니다.

1. ROA가 양수면 1점, 그렇지 않으면 0점
2. 영업활동현금흐름이 양수면 1점, 그렇지 않으면 0점
3. 최근 ROA가 전년 대비 증가했으면 1점, 그렇지 않으면 0점
4. Accurual(CFO - ROA)가 양수면 1점, 그렇지 않으면 0점
5. 레버리지가 전년 대비 증가했으면 1점, 그렇지 않으면 0점
6. 유동성이 전년 대비 증가해으면 1점, 그렇지 않으면 0점
7. 유상증자 항목이 없거나 0보다 작으면 1점, 그렇지 않으면 0점
8. 매출총이익률이 전년 대비 증가했으면 1점, 그렇지 않으면 0점
9. 회전율이 전년 대비 증가했으면 1점, 그렇지 않으면 0점


```r
F_Table = cbind(F_1, F_2, F_3, F_4, F_5, F_6, F_7, F_8, F_9) 
F_Score = F_Table %>%
  apply(., 1, sum, na.rm = TRUE) %>%
  setNames(KOR_ticker$`종목명`)
```

1. `cbind()`를 통해 열의 형태로 묶어줍니다.
2. `apply()` 함수를 통해 종목 별 지표의 합을 더해 F-Score를 계산해줍니다.
3. `setNanmes()` 함수를 통해 종목명을 입력해 줍니다.


```r
(F_dist = prop.table(table(F_Score)) %>% round(3))
```

```
## F_Score
##     0     1     2     3     4     5     6     7     8     9 
## 0.004 0.051 0.093 0.170 0.203 0.188 0.147 0.089 0.044 0.011
```

```r
F_dist %>%
  data.frame() %>%
  ggplot(aes(x = F_Score, y = Freq,
             label = paste0(Freq * 100, '%'))) +
  geom_bar(stat = 'identity') +
  # coord_flip() +
  geom_text(color = 'black', size = 3, vjust = -0.4) +
  scale_y_continuous(expand = c(0, 0, 0, 0.05),
                     labels = scales::percent) +
  ylab(NULL) +
  theme_classic() 
```

<img src="09-factor_basic_files/figure-html/unnamed-chunk-31-1.png" width="50%" style="display: block; margin: auto;" />

`table()` 함수를 통해 각 스코어 별 갯수를 구한 후, `prop.table()`을 통해 비중으로 변환하도록 합니다. 이를 통해 점수 별 비중을 살펴보면 3~6점에 상당히 많은 종목이 분포하고 있음이 확인됩니다.


```r
invest_F_Score = F_Score %in% c(9)
KOR_ticker[invest_F_Score, ] %>% 
  select(`종목코드`, `종목명`) %>%
  mutate(`F-Score` = F_Score[invest_F_Score])
```

```
##    종목코드           종목명 F-Score
## 1    051900       LG생활건강       9
## 2    081660       휠라코리아       9
## 3    271560           오리온       9
## 4    031430 신세계인터내셔날       9
## 5    285130         SK케미칼       9
## 6    011280         태림포장       9
## 7    036540        SFA반도체       9
## 8    044340           위닉스       9
## 9    004690           삼천리       9
## 10   002310       아세아제지       9
## 11   023600         삼보판지       9
## 12   232140     와이아이케이       9
## 13   007980       태평양물산       9
## 14   089010       켐트로닉스       9
## 15   009200       무림페이퍼       9
## 16   203650     드림시큐리티       9
## 17   006580         대양제지       9
## 18   174880         장원테크       9
## 19   008250         이건산업       9
## 20   002200         수출포장       9
## 21   005670           푸드웰       9
## 22   091340        S&K폴리텍       9
## 23   080580       오킨스전자       9
```

F_Score가 9점인 종목의 티커와 종목명을 확인해봅니다. 재무적으로 우량하다고 판단되는 F-Score 9점인 종목은 총 23개가 존재하고 있습니다.

### 각 지표를 결합하기

이번에는 퀄리티를 측정하는 요소 중 가장 널리 사용되는 수익성의 지표를 결합한 포트폴리오를 만들어 보겠으며, 사용되는 지표는 **자기자본이익률(ROE)**, **매출총이익(Gross Profit)**, **영업활동현금흐름(Cashflow From Operating)** 입니다.


```r
library(stringr)
library(ggplot2)
library(dplyr)
library(tidyr)

KOR_fs = readRDS('data/KOR_fs.Rds')
KOR_ticker = read.csv('data/KOR_ticker.csv', row.names = 1, stringsAsFactors = FALSE) 
KOR_ticker$'종목코드' = str_pad(KOR_ticker$'종목코드', 6, 'left', 0)

num_col = ncol(KOR_fs[[1]])
quality_roe = (KOR_fs$'지배주주순이익' / KOR_fs$'자본')[num_col]
quality_gpa = (KOR_fs$'매출총이익' / KOR_fs$'자산')[num_col]
quality_cfo = (KOR_fs$'영업활동으로인한현금흐름' / KOR_fs$'자산')[num_col]
quality_profit = cbind(quality_roe, quality_gpa, quality_cfo) %>%
  setNames(., c('ROE', 'GPA', 'CFO'))
```

먼저 재무제표와 티커 파일을 불러온 후, 세가지 지표에 해당하는 값을 구한 뒤 최근년도 데이터만을 선택합니다. 그 후, `cbind()` 함수를 이용해 지표들을 하나로 묶어줍니다.


```r
rank_quality = quality_profit %>% 
  mutate_all(funs(min_rank(desc(.))))

cor(rank_quality, use = 'complete.obs') %>%
  round(., 2) %>%
  data.frame(ID = rownames(.)) %>%
  gather(index, value, -ID) %>%
  ggplot(aes(x = ID, y = index, fill = value)) +
  geom_tile(color = 'white') +
  scale_fill_gradient2(low = 'blue', high = 'red', mid = 'white',
                       midpoint = 0, limit = c(-1, 1), space = 'Lab', name = 'Correlation') +
  theme_minimal() +
  xlab(NULL) + ylab(NULL) +
  geom_text(aes(x = ID, y = index, label = value), color = 'black', size = 4)
```

<img src="09-factor_basic_files/figure-html/unnamed-chunk-34-1.png" width="50%" style="display: block; margin: auto;" />

`mutate_all()` 함수와 `min_rank()` 함수를 통해 지표 별 랭킹을 구해주도록 하며, 퀄리티 지표의 경우 높을수록 좋은 내림차순으로 계산하여야 하므로, `desc()`을 추가해줍니다.

수익성 지표 역시 서로 간의 상관관계가 낮은 지표가 존재하여, 지표를 통합적으로 고려시 분산효과를 기대할 수 있습니다.


```r
rank_sum = rank_quality %>%
  rowSums()

invest_quality = rank(rank_sum) <= 30

KOR_ticker[invest_quality, ] %>%
  select(`종목코드`, `종목명`) %>%
  cbind(quality_profit[invest_quality, ])
```

```
##      종목코드           종목명       ROE       GPA       CFO
## 2      000660       SK하이닉스 0.3316828 0.3968720 0.3491642
## 10     051900       LG생활건강 0.1899555 0.7678500 0.1548740
## 45     021240       웅진코웨이 0.3219638 0.7688848 0.2266173
## 76     282330        BGF리테일 0.2955722 0.6877108 0.2332389
## 98     086900         메디톡스 0.2721617 0.3827848 0.1394937
## 112    012510       더존비즈온 0.2310648 0.4560459 0.2228202
## 164    192080     더블유게임즈 0.1694000 0.4845506 0.1568018
## 190    030190     NICE평가정보 0.1930444 1.4315554 0.1842596
## 230    214150         클래시스 0.2921569 0.4583884 0.2113606
## 241    067160       아프리카TV 0.2325081 0.8038095 0.2463492
## 308    069080             웹젠 0.1602421 0.5516633 0.2071573
## 309    001820       삼화콘덴서 0.4850863 0.4627273 0.2768182
## 311    090460         비에이치 0.4342735 0.3265219 0.3429119
## 361    192440     슈피겐코리아 0.1634137 0.6276954 0.1280323
## 378    215200   메가스터디교육 0.1893519 0.5539216 0.2500000
## 383    042700       한미반도체 0.2286642 0.3934959 0.1853659
## 399    092730           네오팜 0.2596965 0.6625514 0.2222222
## 469    119860           다나와 0.1822222 0.9806273 0.1531365
## 533    034950     한국기업평가 0.1578947 0.6442234 0.1736802
## 561    086390       유니테스트 0.3713678 0.5697736 0.3391259
## 597    220630 해마로푸드서비스 0.2344828 0.6656201 0.1499215
## 660    092130       이크레더블 0.2598753 0.6572438 0.2367491
## 785    036810       에프에스티 0.1769634 0.3460183 0.2114165
## 811    232140     와이아이케이 0.2460251 0.2868298 0.2306091
## 875    225190       삼양옵틱스 0.3462604 0.5934066 0.3208791
## 1006   130580     나이스디앤비 0.2057522 0.9171076 0.2010582
## 1031   285490           노바텍 0.2218650 0.3132530 0.1897590
## 1141   241790       오션브릿지 0.2445255 0.2841328 0.3603936
## 1580   063760           이엘피 0.2225564 0.3051948 0.2233766
## 1735   031980 피에스케이홀딩스 0.1969809 0.4524703 0.1297686
```

`rowSums()` 함수를 이용해 종목 별 랭킹들의 합을 구해주도록 합니다. 그 후 4개 지표 랭킹의 합 기준 랭킹이 낮은 30 종목을 선택해 줍니다. 즉 세가지 수익 지표가 골고루 높은 종목을 선택하여 줍니다. 해당 종목들의 티커, 종목명, ROE, GPA, CFO을 출력하여 확인하도록 합니다.

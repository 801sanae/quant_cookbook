<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 금융 데이터 수집하기 (심화) | R을 이용한 퀀트 투자 포트폴리오 만들기</title>
  <meta name="description" content="Chapter 6 금융 데이터 수집하기 (심화) | R을 이용한 퀀트 투자 포트폴리오 만들기" />
  <meta name="generator" content="bookdown 0.11 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 금융 데이터 수집하기 (심화) | R을 이용한 퀀트 투자 포트폴리오 만들기" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="hyunyulhenry/quant_cookbook" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 금융 데이터 수집하기 (심화) | R을 이용한 퀀트 투자 포트폴리오 만들기" />
  
  
  

<meta name="author" content="이현열" />


<meta name="date" content="2020-01-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="section-23.html">
<link rel="next" href="section-42.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/dygraphs-1.1.1/dygraph.css" rel="stylesheet" />
<script src="libs/dygraphs-1.1.1/dygraph-combined.js"></script>
<script src="libs/dygraphs-1.1.1/shapes.js"></script>
<script src="libs/moment-2.8.4/moment.js"></script>
<script src="libs/moment-timezone-0.2.5/moment-timezone-with-data.js"></script>
<script src="libs/moment-fquarter-1.0.0/moment-fquarter.min.js"></script>
<script src="libs/dygraphs-binding-1.1.1.6/dygraphs.js"></script>
<script src="libs/proj4js-2.3.15/proj4.js"></script>
<link href="libs/highcharts-7.0.1/css/motion.css" rel="stylesheet" />
<link href="libs/highcharts-7.0.1/css/htmlwdgtgrid.css" rel="stylesheet" />
<script src="libs/highcharts-7.0.1/highcharts.js"></script>
<script src="libs/highcharts-7.0.1/highcharts-3d.js"></script>
<script src="libs/highcharts-7.0.1/highcharts-more.js"></script>
<script src="libs/highcharts-7.0.1/modules/stock.js"></script>
<script src="libs/highcharts-7.0.1/modules/map.js"></script>
<script src="libs/highcharts-7.0.1/modules/annotations.js"></script>
<script src="libs/highcharts-7.0.1/modules/boost.js"></script>
<script src="libs/highcharts-7.0.1/modules/data.js"></script>
<script src="libs/highcharts-7.0.1/modules/drag-panes.js"></script>
<script src="libs/highcharts-7.0.1/modules/drilldown.js"></script>
<script src="libs/highcharts-7.0.1/modules/item-series.js"></script>
<script src="libs/highcharts-7.0.1/modules/offline-exporting.js"></script>
<script src="libs/highcharts-7.0.1/modules/overlapping-datalabels.js"></script>
<script src="libs/highcharts-7.0.1/modules/exporting.js"></script>
<script src="libs/highcharts-7.0.1/modules/export-data.js"></script>
<script src="libs/highcharts-7.0.1/modules/funnel.js"></script>
<script src="libs/highcharts-7.0.1/modules/heatmap.js"></script>
<script src="libs/highcharts-7.0.1/modules/treemap.js"></script>
<script src="libs/highcharts-7.0.1/modules/sankey.js"></script>
<script src="libs/highcharts-7.0.1/modules/solid-gauge.js"></script>
<script src="libs/highcharts-7.0.1/modules/streamgraph.js"></script>
<script src="libs/highcharts-7.0.1/modules/sunburst.js"></script>
<script src="libs/highcharts-7.0.1/modules/vector.js"></script>
<script src="libs/highcharts-7.0.1/modules/wordcloud.js"></script>
<script src="libs/highcharts-7.0.1/modules/xrange.js"></script>
<script src="libs/highcharts-7.0.1/modules/tilemap.js"></script>
<script src="libs/highcharts-7.0.1/modules/venn.js"></script>
<script src="libs/highcharts-7.0.1/modules/gantt.js"></script>
<script src="libs/highcharts-7.0.1/modules/timeline.js"></script>
<script src="libs/highcharts-7.0.1/modules/parallel-coordinates.js"></script>
<script src="libs/highcharts-7.0.1/plugins/grouped-categories.js"></script>
<script src="libs/highcharts-7.0.1/plugins/motion.js"></script>
<script src="libs/highcharts-7.0.1/plugins/multicolor_series.js"></script>
<script src="libs/highcharts-7.0.1/custom/reset.js"></script>
<script src="libs/highcharts-7.0.1/custom/symbols-extra.js"></script>
<script src="libs/highcharts-7.0.1/custom/text-symbols.js"></script>
<script src="libs/highchart-binding-0.7.0/highchart.js"></script>
<script src="libs/plotly-binding-4.9.0/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.46.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.46.1/plotly-latest.min.js"></script>
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R을 이용한 퀀트 투자 포트폴리오 만들기</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#section"><i class="fa fa-check"></i>지은이 소개</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#section-1"><i class="fa fa-check"></i>머리말</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#section-2"><i class="fa fa-check"></i>이 책의 구성</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#section-3"><i class="fa fa-check"></i>이 책에서 다루지 않은 주제</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#section-4"><i class="fa fa-check"></i>도움이 될 만한 자료들</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#section-5"><i class="fa fa-check"></i>이 책의 지원 페이지</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#section-6"><i class="fa fa-check"></i>종목과 관련된 유의사항</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="section-7.html"><a href="section-7.html"><i class="fa fa-check"></i><b>1</b> 퀀트 투자의 심장: 데이터와 프로그래밍</a><ul>
<li class="chapter" data-level="1.1" data-path="section-7.html"><a href="section-7.html#section-8"><i class="fa fa-check"></i><b>1.1</b> 데이터 구하기</a></li>
<li class="chapter" data-level="1.2" data-path="section-7.html"><a href="section-7.html#section-9"><i class="fa fa-check"></i><b>1.2</b> 퀀트 투자와 프로그래밍</a></li>
<li class="chapter" data-level="1.3" data-path="section-7.html"><a href="section-7.html#r-"><i class="fa fa-check"></i><b>1.3</b> R 프로그램</a></li>
<li class="chapter" data-level="1.4" data-path="section-7.html"><a href="section-7.html#r--1"><i class="fa fa-check"></i><b>1.4</b> 퀀트 투자에 유용한 R 패키지</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="section-10.html"><a href="section-10.html"><i class="fa fa-check"></i><b>2</b> 크롤링을 위한 기본 지식</a><ul>
<li class="chapter" data-level="2.1" data-path="section-10.html"><a href="section-10.html#r-utf-8-"><i class="fa fa-check"></i><b>2.1</b> 인코딩의 이해와 R에서 UTF-8 설정하기</a><ul>
<li class="chapter" data-level="2.1.1" data-path="section-10.html"><a href="section-10.html#ascii"><i class="fa fa-check"></i><b>2.1.1</b> 인간과 컴퓨터 간 번역의 시작, ASCII</a></li>
<li class="chapter" data-level="2.1.2" data-path="section-10.html"><a href="section-10.html#section-11"><i class="fa fa-check"></i><b>2.1.2</b> 한글 인코딩 방식의 종류</a></li>
<li class="chapter" data-level="2.1.3" data-path="section-10.html"><a href="section-10.html#r-utf-8--1"><i class="fa fa-check"></i><b>2.1.3</b> R에서 UTF-8 설정하기</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="section-10.html"><a href="section-10.html#section-12"><i class="fa fa-check"></i><b>2.2</b> 웹의 동작 방식</a><ul>
<li class="chapter" data-level="2.2.1" data-path="section-10.html"><a href="section-10.html#http"><i class="fa fa-check"></i><b>2.2.1</b> HTTP</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="section-10.html"><a href="section-10.html#html-css"><i class="fa fa-check"></i><b>2.3</b> HTML과 CSS</a><ul>
<li class="chapter" data-level="2.3.1" data-path="section-10.html"><a href="section-10.html#html--"><i class="fa fa-check"></i><b>2.3.1</b> HTML 기본 구조</a></li>
<li class="chapter" data-level="2.3.2" data-path="section-10.html"><a href="section-10.html#section-13"><i class="fa fa-check"></i><b>2.3.2</b> 태그와 속성</a></li>
<li class="chapter" data-level="2.3.3" data-path="section-10.html"><a href="section-10.html#h--p-"><i class="fa fa-check"></i><b>2.3.3</b> h 태그와 p 태그</a></li>
<li class="chapter" data-level="2.3.4" data-path="section-10.html"><a href="section-10.html#ul--ol-"><i class="fa fa-check"></i><b>2.3.4</b> 리스트를 나타내는 ul 태그와 ol 태그</a></li>
<li class="chapter" data-level="2.3.5" data-path="section-10.html"><a href="section-10.html#table-"><i class="fa fa-check"></i><b>2.3.5</b> table 태그</a></li>
<li class="chapter" data-level="2.3.6" data-path="section-10.html"><a href="section-10.html#a--src---"><i class="fa fa-check"></i><b>2.3.6</b> a 태그와 src 태그 및 속성</a></li>
<li class="chapter" data-level="2.3.7" data-path="section-10.html"><a href="section-10.html#div-"><i class="fa fa-check"></i><b>2.3.7</b> div 태그</a></li>
<li class="chapter" data-level="2.3.8" data-path="section-10.html"><a href="section-10.html#css"><i class="fa fa-check"></i><b>2.3.8</b> CSS</a></li>
<li class="chapter" data-level="2.3.9" data-path="section-10.html"><a href="section-10.html#id"><i class="fa fa-check"></i><b>2.3.9</b> 클래스와 id</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="section-10.html"><a href="section-10.html#section-14"><i class="fa fa-check"></i><b>2.4</b> 파이프 오퍼레이터(<code>%&gt;%</code>)</a></li>
<li class="chapter" data-level="2.5" data-path="section-10.html"><a href="section-10.html#section-15"><i class="fa fa-check"></i><b>2.5</b> 오류에 대한 예외처리</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="api-.html"><a href="api-.html"><i class="fa fa-check"></i><b>3</b> API를 이용한 데이터 수집</a><ul>
<li class="chapter" data-level="3.1" data-path="api-.html"><a href="api-.html#api--quandl--"><i class="fa fa-check"></i><b>3.1</b> API를 이용한 Quandl 데이터 다운로드</a></li>
<li class="chapter" data-level="3.2" data-path="api-.html"><a href="api-.html#getsymbols---api-"><i class="fa fa-check"></i><b>3.2</b> <code>getSymbols()</code> 함수를 이용한 API 다운로드</a><ul>
<li class="chapter" data-level="3.2.1" data-path="api-.html"><a href="api-.html#section-16"><i class="fa fa-check"></i><b>3.2.1</b> 주가 다운로드</a></li>
<li class="chapter" data-level="3.2.2" data-path="api-.html"><a href="api-.html#section-17"><i class="fa fa-check"></i><b>3.2.2</b> 국내 종목 주가 다운로드</a></li>
<li class="chapter" data-level="3.2.3" data-path="api-.html"><a href="api-.html#fred--"><i class="fa fa-check"></i><b>3.2.3</b> FRED 데이터 다운로드</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="section-18.html"><a href="section-18.html"><i class="fa fa-check"></i><b>4</b> 크롤링 이해하기</a><ul>
<li class="chapter" data-level="4.1" data-path="section-18.html"><a href="section-18.html#get-post--"><i class="fa fa-check"></i><b>4.1</b> GET과 POST 방식 이해하기</a><ul>
<li class="chapter" data-level="4.1.1" data-path="section-18.html"><a href="section-18.html#get-"><i class="fa fa-check"></i><b>4.1.1</b> GET 방식</a></li>
<li class="chapter" data-level="4.1.2" data-path="section-18.html"><a href="section-18.html#post-"><i class="fa fa-check"></i><b>4.1.2</b> POST 방식</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="section-18.html"><a href="section-18.html#section-19"><i class="fa fa-check"></i><b>4.2</b> 크롤링 예제</a><ul>
<li class="chapter" data-level="4.2.1" data-path="section-18.html"><a href="section-18.html#section-20"><i class="fa fa-check"></i><b>4.2.1</b> 금융 속보 크롤링</a></li>
<li class="chapter" data-level="4.2.2" data-path="section-18.html"><a href="section-18.html#section-21"><i class="fa fa-check"></i><b>4.2.2</b> 기업공시채널에서 오늘의 공시 불러오기</a></li>
<li class="chapter" data-level="4.2.3" data-path="section-18.html"><a href="section-18.html#section-22"><i class="fa fa-check"></i><b>4.2.3</b> 네이버 금융에서 주식티커 크롤링</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="section-23.html"><a href="section-23.html"><i class="fa fa-check"></i><b>5</b> 금융 데이터 수집하기 (기본)</a><ul>
<li class="chapter" data-level="5.1" data-path="section-23.html"><a href="section-23.html#section-24"><i class="fa fa-check"></i><b>5.1</b> 한국거래소의 산업별 현황 및 개별지표 크롤링</a><ul>
<li class="chapter" data-level="5.1.1" data-path="section-23.html"><a href="section-23.html#section-25"><i class="fa fa-check"></i><b>5.1.1</b> 산업별 현황 크롤링</a></li>
<li class="chapter" data-level="5.1.2" data-path="section-23.html"><a href="section-23.html#section-26"><i class="fa fa-check"></i><b>5.1.2</b> 개별종목 지표 크롤링</a></li>
<li class="chapter" data-level="5.1.3" data-path="section-23.html"><a href="section-23.html#section-27"><i class="fa fa-check"></i><b>5.1.3</b> 최근 영업일 기준 데이터 받기</a></li>
<li class="chapter" data-level="5.1.4" data-path="section-23.html"><a href="section-23.html#section-28"><i class="fa fa-check"></i><b>5.1.4</b> 거래소 데이터 정리하기</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="section-23.html"><a href="section-23.html#wics---"><i class="fa fa-check"></i><b>5.2</b> WICS 기준 섹터정보 크롤링</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="section-29.html"><a href="section-29.html"><i class="fa fa-check"></i><b>6</b> 금융 데이터 수집하기 (심화)</a><ul>
<li class="chapter" data-level="6.1" data-path="section-29.html"><a href="section-29.html#section-30"><i class="fa fa-check"></i><b>6.1</b> 수정주가 크롤링</a><ul>
<li class="chapter" data-level="6.1.1" data-path="section-29.html"><a href="section-29.html#section-31"><i class="fa fa-check"></i><b>6.1.1</b> 개별종목 주가 크롤링</a></li>
<li class="chapter" data-level="6.1.2" data-path="section-29.html"><a href="section-29.html#section-32"><i class="fa fa-check"></i><b>6.1.2</b> 전 종목 주가 크롤링</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="section-29.html"><a href="section-29.html#section-33"><i class="fa fa-check"></i><b>6.2</b> 재무제표 및 가치지표 크롤링</a><ul>
<li class="chapter" data-level="6.2.1" data-path="section-29.html"><a href="section-29.html#section-34"><i class="fa fa-check"></i><b>6.2.1</b> 재무제표 다운로드</a></li>
<li class="chapter" data-level="6.2.2" data-path="section-29.html"><a href="section-29.html#section-35"><i class="fa fa-check"></i><b>6.2.2</b> 가치지표 계산하기</a></li>
<li class="chapter" data-level="6.2.3" data-path="section-29.html"><a href="section-29.html#section-36"><i class="fa fa-check"></i><b>6.2.3</b> 전 종목 재무제표 및 가치지표 다운로드</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="section-29.html"><a href="section-29.html#dart--"><i class="fa fa-check"></i><b>6.3</b> DART 데이터 수집하기</a><ul>
<li class="chapter" data-level="6.3.1" data-path="section-29.html"><a href="section-29.html#section-37"><i class="fa fa-check"></i><b>6.3.1</b> 인증키 발급받기</a></li>
<li class="chapter" data-level="6.3.2" data-path="section-29.html"><a href="section-29.html#section-38"><i class="fa fa-check"></i><b>6.3.2</b> 오늘의 공시 확인하기</a></li>
<li class="chapter" data-level="6.3.3" data-path="section-29.html"><a href="section-29.html#section-40"><i class="fa fa-check"></i><b>6.3.3</b> 사업보고서의 재무제표 다운로드</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="section-42.html"><a href="section-42.html"><i class="fa fa-check"></i><b>7</b> 데이터 정리하기</a><ul>
<li class="chapter" data-level="7.1" data-path="section-42.html"><a href="section-42.html#section-43"><i class="fa fa-check"></i><b>7.1</b> 주가 정리하기</a></li>
<li class="chapter" data-level="7.2" data-path="section-42.html"><a href="section-42.html#section-44"><i class="fa fa-check"></i><b>7.2</b> 재무제표 정리하기</a></li>
<li class="chapter" data-level="7.3" data-path="section-42.html"><a href="section-42.html#section-45"><i class="fa fa-check"></i><b>7.3</b> 가치지표 정리하기</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="section-46.html"><a href="section-46.html"><i class="fa fa-check"></i><b>8</b> 데이터 분석 및 시각화하기</a><ul>
<li class="chapter" data-level="8.1" data-path="section-46.html"><a href="section-46.html#section-47"><i class="fa fa-check"></i><b>8.1</b> 종목정보 데이터 분석</a><ul>
<li class="chapter" data-level="8.1.1" data-path="section-46.html"><a href="section-46.html#join--"><i class="fa fa-check"></i><b>8.1.1</b> <code>*_join</code>: 데이터 합치기</a></li>
<li class="chapter" data-level="8.1.2" data-path="section-46.html"><a href="section-46.html#glimpse---"><i class="fa fa-check"></i><b>8.1.2</b> <code>glimpse()</code>: 데이터 구조 확인하기</a></li>
<li class="chapter" data-level="8.1.3" data-path="section-46.html"><a href="section-46.html#rename---"><i class="fa fa-check"></i><b>8.1.3</b> <code>rename()</code>: 열 이름 바꾸기</a></li>
<li class="chapter" data-level="8.1.4" data-path="section-46.html"><a href="section-46.html#distinct---"><i class="fa fa-check"></i><b>8.1.4</b> distinct(): 고유한 값 확인</a></li>
<li class="chapter" data-level="8.1.5" data-path="section-46.html"><a href="section-46.html#select---"><i class="fa fa-check"></i><b>8.1.5</b> <code>select()</code>: 원하는 열만 선택</a></li>
<li class="chapter" data-level="8.1.6" data-path="section-46.html"><a href="section-46.html#mutate-----"><i class="fa fa-check"></i><b>8.1.6</b> <code>mutate()</code>: 열 생성 및 데이터 변형</a></li>
<li class="chapter" data-level="8.1.7" data-path="section-46.html"><a href="section-46.html#filter----"><i class="fa fa-check"></i><b>8.1.7</b> <code>filter()</code>: 조건을 충족하는 행 선택</a></li>
<li class="chapter" data-level="8.1.8" data-path="section-46.html"><a href="section-46.html#summarize---"><i class="fa fa-check"></i><b>8.1.8</b> <code>summarize()</code>: 요약 통곗값 계산</a></li>
<li class="chapter" data-level="8.1.9" data-path="section-46.html"><a href="section-46.html#arrange--"><i class="fa fa-check"></i><b>8.1.9</b> <code>arrange()</code>: 데이터 정렬</a></li>
<li class="chapter" data-level="8.1.10" data-path="section-46.html"><a href="section-46.html#row_number--"><i class="fa fa-check"></i><b>8.1.10</b> <code>row_number()</code>: 순위 계산</a></li>
<li class="chapter" data-level="8.1.11" data-path="section-46.html"><a href="section-46.html#ntile--"><i class="fa fa-check"></i><b>8.1.11</b> <code>ntile()</code>: 분위수 계산</a></li>
<li class="chapter" data-level="8.1.12" data-path="section-46.html"><a href="section-46.html#group_by---"><i class="fa fa-check"></i><b>8.1.12</b> <code>group_by()</code>: 그룹별로 데이터를 묶기</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="section-46.html"><a href="section-46.html#section-48"><i class="fa fa-check"></i><b>8.2</b> 종목정보 시각화</a><ul>
<li class="chapter" data-level="8.2.1" data-path="section-46.html"><a href="section-46.html#geom_point--"><i class="fa fa-check"></i><b>8.2.1</b> <code>geom_point()</code>: 산점도 나타내기</a></li>
<li class="chapter" data-level="8.2.2" data-path="section-46.html"><a href="section-46.html#geom_histogram--"><i class="fa fa-check"></i><b>8.2.2</b> <code>geom_histogram()</code>: 히스토그램 나타내기</a></li>
<li class="chapter" data-level="8.2.3" data-path="section-46.html"><a href="section-46.html#geom_boxplot---"><i class="fa fa-check"></i><b>8.2.3</b> <code>geom_boxplot()</code>: 박스 플롯 나타내기</a></li>
<li class="chapter" data-level="8.2.4" data-path="section-46.html"><a href="section-46.html#dplyr-ggplot--"><i class="fa fa-check"></i><b>8.2.4</b> <code>dplyr</code>과 <code>ggplot</code>을 연결하여 사용하기</a></li>
<li class="chapter" data-level="8.2.5" data-path="section-46.html"><a href="section-46.html#geom_bar---"><i class="fa fa-check"></i><b>8.2.5</b> <code>geom_bar()</code>: 막대 그래프 나타내기</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="section-46.html"><a href="section-46.html#section-49"><i class="fa fa-check"></i><b>8.3</b> 주가 및 수익률 시각화</a><ul>
<li class="chapter" data-level="8.3.1" data-path="section-46.html"><a href="section-46.html#section-50"><i class="fa fa-check"></i><b>8.3.1</b> 주가 그래프 나타내기</a></li>
<li class="chapter" data-level="8.3.2" data-path="section-46.html"><a href="section-46.html#section-51"><i class="fa fa-check"></i><b>8.3.2</b> 인터랙티브 그래프 나타내기</a></li>
<li class="chapter" data-level="8.3.3" data-path="section-46.html"><a href="section-46.html#section-52"><i class="fa fa-check"></i><b>8.3.3</b> 연도별 수익률 나타내기</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="section-53.html"><a href="section-53.html"><i class="fa fa-check"></i><b>9</b> 퀀트 전략을 이용한 종목선정 (기본)</a><ul>
<li class="chapter" data-level="9.1" data-path="section-53.html"><a href="section-53.html#section-54"><i class="fa fa-check"></i><b>9.1</b> 베타 이해하기</a><ul>
<li class="chapter" data-level="9.1.1" data-path="section-53.html"><a href="section-53.html#section-55"><i class="fa fa-check"></i><b>9.1.1</b> 베타 계산하기</a></li>
<li class="chapter" data-level="9.1.2" data-path="section-53.html"><a href="section-53.html#section-56"><i class="fa fa-check"></i><b>9.1.2</b> 베타 시각화</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="section-53.html"><a href="section-53.html#section-57"><i class="fa fa-check"></i><b>9.2</b> 저변동성 전략</a><ul>
<li class="chapter" data-level="9.2.1" data-path="section-53.html"><a href="section-53.html#section-58"><i class="fa fa-check"></i><b>9.2.1</b> 저변동성 포트폴리오 구하기: 일간 기준</a></li>
<li class="chapter" data-level="9.2.2" data-path="section-53.html"><a href="section-53.html#section-59"><i class="fa fa-check"></i><b>9.2.2</b> 저변동성 포트폴리오 구하기: 주간 기준</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="section-53.html"><a href="section-53.html#section-60"><i class="fa fa-check"></i><b>9.3</b> 모멘텀 전략</a><ul>
<li class="chapter" data-level="9.3.1" data-path="section-53.html"><a href="section-53.html#section-61"><i class="fa fa-check"></i><b>9.3.1</b> 모멘텀 포트폴리오 구하기: 12개월 모멘텀</a></li>
<li class="chapter" data-level="9.3.2" data-path="section-53.html"><a href="section-53.html#section-62"><i class="fa fa-check"></i><b>9.3.2</b> 모멘텀 포트폴리오 구하기: 위험조정 수익률</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="section-53.html"><a href="section-53.html#section-63"><i class="fa fa-check"></i><b>9.4</b> 밸류 전략</a><ul>
<li class="chapter" data-level="9.4.1" data-path="section-53.html"><a href="section-53.html#pbr"><i class="fa fa-check"></i><b>9.4.1</b> 밸류 포트폴리오 구하기: 저PBR</a></li>
<li class="chapter" data-level="9.4.2" data-path="section-53.html"><a href="section-53.html#section-64"><i class="fa fa-check"></i><b>9.4.2</b> 각 지표 결합하기</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="section-53.html"><a href="section-53.html#section-65"><i class="fa fa-check"></i><b>9.5</b> 퀄리티 전략</a><ul>
<li class="chapter" data-level="9.5.1" data-path="section-53.html"><a href="section-53.html#f-score"><i class="fa fa-check"></i><b>9.5.1</b> F-Score</a></li>
<li class="chapter" data-level="9.5.2" data-path="section-53.html"><a href="section-53.html#section-66"><i class="fa fa-check"></i><b>9.5.2</b> 각 지표를 결합하기</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="section-67.html"><a href="section-67.html"><i class="fa fa-check"></i><b>10</b> 퀀트 전략을 이용한 종목선정 (심화)</a><ul>
<li class="chapter" data-level="10.1" data-path="section-67.html"><a href="section-67.html#section-68"><i class="fa fa-check"></i><b>10.1</b> 섹터 중립 포트폴리오</a></li>
<li class="chapter" data-level="10.2" data-path="section-67.html"><a href="section-67.html#section-69"><i class="fa fa-check"></i><b>10.2</b> 마법공식</a><ul>
<li class="chapter" data-level="10.2.1" data-path="section-67.html"><a href="section-67.html#section-70"><i class="fa fa-check"></i><b>10.2.1</b> 퀄리티와 밸류 간의 관계</a></li>
<li class="chapter" data-level="10.2.2" data-path="section-67.html"><a href="section-67.html#section-71"><i class="fa fa-check"></i><b>10.2.2</b> 마법공식 이해하기</a></li>
<li class="chapter" data-level="10.2.3" data-path="section-67.html"><a href="section-67.html#section-72"><i class="fa fa-check"></i><b>10.2.3</b> 마법공식 구성하기</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="section-67.html"><a href="section-67.html#section-73"><i class="fa fa-check"></i><b>10.3</b> 이상치 데이터 제거 및 팩터의 결합</a><ul>
<li class="chapter" data-level="10.3.1" data-path="section-67.html"><a href="section-67.html#trim---"><i class="fa fa-check"></i><b>10.3.1</b> 트림(Trim): 이상치 데이터 삭제</a></li>
<li class="chapter" data-level="10.3.2" data-path="section-67.html"><a href="section-67.html#winsorizing---"><i class="fa fa-check"></i><b>10.3.2</b> 윈저라이징(Winsorizing): 이상치 데이터 대체</a></li>
<li class="chapter" data-level="10.3.3" data-path="section-67.html"><a href="section-67.html#section-74"><i class="fa fa-check"></i><b>10.3.3</b> 팩터의 결합 방법</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="section-67.html"><a href="section-67.html#section-75"><i class="fa fa-check"></i><b>10.4</b> 멀티팩터 포트폴리오</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="section-76.html"><a href="section-76.html"><i class="fa fa-check"></i><b>11</b> 포트폴리오 구성</a><ul>
<li class="chapter" data-level="11.1" data-path="section-76.html"><a href="section-76.html#section-77"><i class="fa fa-check"></i><b>11.1</b> 최소분산 포트폴리오</a><ul>
<li class="chapter" data-level="11.1.1" data-path="section-76.html"><a href="section-76.html#slsqp---"><i class="fa fa-check"></i><b>11.1.1</b> <code>slsqp()</code> 함수를 이용한 최적화</a></li>
<li class="chapter" data-level="11.1.2" data-path="section-76.html"><a href="section-76.html#solve.qp---"><i class="fa fa-check"></i><b>11.1.2</b> <code>solve.QP()</code> 함수를 이용한 최적화</a></li>
<li class="chapter" data-level="11.1.3" data-path="section-76.html"><a href="section-76.html#optimalportfolio---"><i class="fa fa-check"></i><b>11.1.3</b> <code>optimalPortfolio()</code> 함수를 이용한 최적화</a></li>
<li class="chapter" data-level="11.1.4" data-path="section-76.html"><a href="section-76.html#section-78"><i class="fa fa-check"></i><b>11.1.4</b> 결괏값들의 비교</a></li>
<li class="chapter" data-level="11.1.5" data-path="section-76.html"><a href="section-76.html#section-79"><i class="fa fa-check"></i><b>11.1.5</b> 최소 및 최대 투자비중 제약조건</a></li>
<li class="chapter" data-level="11.1.6" data-path="section-76.html"><a href="section-76.html#section-80"><i class="fa fa-check"></i><b>11.1.6</b> 각 자산별 제약조건의 추가</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="section-76.html"><a href="section-76.html#section-81"><i class="fa fa-check"></i><b>11.2</b> 최대분산효과 포트폴리오</a><ul>
<li class="chapter" data-level="11.2.1" data-path="section-76.html"><a href="section-76.html#solve.qp----1"><i class="fa fa-check"></i><b>11.2.1</b> <code>solve.QP()</code> 함수를 이용한 최적화</a></li>
<li class="chapter" data-level="11.2.2" data-path="section-76.html"><a href="section-76.html#optimalportfolio----1"><i class="fa fa-check"></i><b>11.2.2</b> <code>optimalPortfolio()</code> 함수를 이용한 최적화</a></li>
<li class="chapter" data-level="11.2.3" data-path="section-76.html"><a href="section-76.html#section-82"><i class="fa fa-check"></i><b>11.2.3</b> 최소 및 최대 투자비중 제약조건</a></li>
<li class="chapter" data-level="11.2.4" data-path="section-76.html"><a href="section-76.html#section-83"><i class="fa fa-check"></i><b>11.2.4</b> 각 자산 별 제약조건의 추가</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="section-76.html"><a href="section-76.html#section-84"><i class="fa fa-check"></i><b>11.3</b> 위험균형 포트폴리오</a><ul>
<li class="chapter" data-level="11.3.1" data-path="section-76.html"><a href="section-76.html#section-85"><i class="fa fa-check"></i><b>11.3.1</b> 주식 60%와 채권 40% 포트폴리오의 위험기여도</a></li>
<li class="chapter" data-level="11.3.2" data-path="section-76.html"><a href="section-76.html#rp---"><i class="fa fa-check"></i><b>11.3.2</b> <code>rp()</code> 함수를 이용한 최적화</a></li>
<li class="chapter" data-level="11.3.3" data-path="section-76.html"><a href="section-76.html#section-86"><i class="fa fa-check"></i><b>11.3.3</b> 위험예산 포트폴리오</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="section-87.html"><a href="section-87.html"><i class="fa fa-check"></i><b>12</b> 포트폴리오 백테스트</a><ul>
<li class="chapter" data-level="12.1" data-path="section-87.html"><a href="section-87.html#return.portfolio-"><i class="fa fa-check"></i><b>12.1</b> <code>Return.Portfolio()</code> 함수</a><ul>
<li class="chapter" data-level="12.1.1" data-path="section-87.html"><a href="section-87.html#section-88"><i class="fa fa-check"></i><b>12.1.1</b> 인자 목록 살펴보기</a></li>
<li class="chapter" data-level="12.1.2" data-path="section-87.html"><a href="section-87.html#section-89"><i class="fa fa-check"></i><b>12.1.2</b> 출력값 살펴보기</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="section-87.html"><a href="section-87.html#section-90"><i class="fa fa-check"></i><b>12.2</b> 전통적인 60대 40 포트폴리오 백테스트</a></li>
<li class="chapter" data-level="12.3" data-path="section-87.html"><a href="section-87.html#section-91"><i class="fa fa-check"></i><b>12.3</b> 시점 선택 전략 백테스트</a></li>
<li class="chapter" data-level="12.4" data-path="section-87.html"><a href="section-87.html#section-92"><i class="fa fa-check"></i><b>12.4</b> 동적 자산배분 백테스트</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="section-93.html"><a href="section-93.html"><i class="fa fa-check"></i><b>13</b> 성과 및 위험 평가</a><ul>
<li class="chapter" data-level="13.1" data-path="section-93.html"><a href="section-93.html#section-94"><i class="fa fa-check"></i><b>13.1</b> 결과 측정 지표</a><ul>
<li class="chapter" data-level="13.1.1" data-path="section-93.html"><a href="section-93.html#section-95"><i class="fa fa-check"></i><b>13.1.1</b> 수익률 및 변동성</a></li>
<li class="chapter" data-level="13.1.2" data-path="section-93.html"><a href="section-93.html#section-96"><i class="fa fa-check"></i><b>13.1.2</b> 낙폭과 최대낙폭</a></li>
<li class="chapter" data-level="13.1.3" data-path="section-93.html"><a href="section-93.html#section-97"><i class="fa fa-check"></i><b>13.1.3</b> 연도별 수익률</a></li>
<li class="chapter" data-level="13.1.4" data-path="section-93.html"><a href="section-93.html#section-98"><i class="fa fa-check"></i><b>13.1.4</b> 승률 및 롤링 윈도우 값</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="section-93.html"><a href="section-93.html#section-99"><i class="fa fa-check"></i><b>13.2</b> 팩터 회귀분석 및 테이블로 나타내기</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="http://henryquant.blogspot.com/" target="blank">Henry's Quantopia</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R을 이용한 퀀트 투자 포트폴리오 만들기</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="section-29" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> 금융 데이터 수집하기 (심화)</h1>
<p>지난 CHAPTER에서 수집한 주식티커를 바탕으로 이번 CHAPTER에서는 퀀트 투자의 핵심 자료인 수정주가, 재무제표, 가치지표를 크롤링하는 방법을 알아보겠습니다.</p>
<div id="section-30" class="section level2">
<h2><span class="header-section-number">6.1</span> 수정주가 크롤링</h2>
<p>주가 데이터는 투자를 함에 있어 반드시 필요한 데이터이며, 인터넷에서 주가를 수집할 수 있는 방법은 매우 많습니다. 먼저 API를 이용한 데이터 수집에서 살펴본 것과 같이, <code>getSymbols()</code> 함수를 이용해 데이터를 받을 수 있습니다. 그러나 야후 파이낸스에서 제공하는 데이터 중 미국 주가는 이상 없이 다운로드되지만, 국내 중소형주는 주가가 없는 경우가 있습니다.</p>
<p>또한 단순 주가를 구할 수 있는 방법은 많지만, 투자에 필요한 수정주가를 구할 수 있는 방법은 찾기 힘듭니다. 다행히 네이버 금융에서 제공하는 정보를 통해 모든 종목의 수정주가를 매우 손쉽게 구할 수 있습니다.</p>
<div id="section-31" class="section level3">
<h3><span class="header-section-number">6.1.1</span> 개별종목 주가 크롤링</h3>
<p>먼저 네이버 금융에서 특정종목(예: 삼성전자)의 [차트] 탭<a href="#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a>을 선택합니다.<a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a> 해당 차트는 주가 데이터를 받아 그래프를 그려주는 형태입니다. 따라서 해당 데이터가 어디에서 오는지 알기 위해 개발자 도구 화면을 이용합니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-3"></span>
<img src="images/crawl_practice_price2.png" alt="네이버금융 차트의 통신기록" width="70%" />
<p class="caption">
그림 2.1: 네이버금융 차트의 통신기록
</p>
</div>
<p>화면을 연 상태에서 [일봉] 탭을 선택하면 sise.nhn, schedule.nhn, notice.nhn 총 세 가지 항목이 생성됩니다. 이 중 sise.nhn 항목의 Request URL이 주가 데이터를 요청하는 주소입니다. 해당 URL에 접속해보겠습니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-4"></span>
<img src="images/crawl_practice_price3.png" alt="주가 데이터 페이지" width="70%" />
<p class="caption">
그림 2.4: 주가 데이터 페이지
</p>
</div>
<p>각 날짜별로 시가, 고가, 저가, 종가, 거래량이 있으며, 주가는 모두 수정주가 기준입니다. 또한 해당 데이터가 item 태그 내 data 속성에 위치하고 있습니다.</p>
<p>URL에서 symbol= 뒤에 6자리 티커만 변경하면 해당 종목의 주가 데이터가 있는 페이지로 이동할 수 있으며, 우리가 원하는 모든 종목의 주가 데이터를 크롤링할 수 있습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)

KOR_ticker =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;data/KOR_ticker.csv&#39;</span>, <span class="dt">row.names =</span> <span class="dv">1</span>)
<span class="kw">print</span>(KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span>[<span class="dv">1</span>])</code></pre>
<pre><code>## [1] 5930</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span> =
<span class="st">  </span><span class="kw">str_pad</span>(KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span>, <span class="dv">6</span>, <span class="dt">side =</span> <span class="kw">c</span>(<span class="st">&#39;left&#39;</span>), <span class="dt">pad =</span> <span class="st">&#39;0&#39;</span>)</code></pre>
<p>먼저 저장해두었던 csv 파일을 불러옵니다. 종목코드를 살펴보면 005930이어야 할 삼성전자의 티커가 5930으로 입력되어 있습니다. 이는 파일을 불러오는 과정에서 0으로 시작하는 숫자들이 지워졌기 때문입니다. stringr 패키지의 <code>str_pad()</code> 함수를 사용해 6자리가 되지 않는 문자는 왼쪽에 0을 추가해 강제로 6자리로 만들어주도록 합니다.</p>
<p>다음은 첫 번째 종목인 삼성전자의 주가를 크롤링한 후 가공하는 방법입니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(xts)

<span class="kw">ifelse</span>(<span class="kw">dir.exists</span>(<span class="st">&#39;data/KOR_price&#39;</span>), <span class="ot">FALSE</span>,
       <span class="kw">dir.create</span>(<span class="st">&#39;data/KOR_price&#39;</span>))</code></pre>
<pre><code>## [1] FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">i =<span class="st"> </span><span class="dv">1</span>
name =<span class="st"> </span>KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span>[i]

price =<span class="st"> </span><span class="kw">xts</span>(<span class="ot">NA</span>, <span class="dt">order.by =</span> <span class="kw">Sys.Date</span>())
<span class="kw">print</span>(price)</code></pre>
<pre><code>##            [,1]
## 2020-01-20   NA</code></pre>
<ol style="list-style-type: decimal">
<li>data 폴더 내에 KOR_price 폴더를 생성합니다.</li>
<li>i = 1을 입력합니다. 향후 for loop 구문을 통해 i 값만 변경하면 모든 종목의 주가를 다운로드할 수 있습니다.</li>
<li>name에 해당 티커를 입력합니다.</li>
<li><code>xts()</code> 함수를 이용해 빈 시계열 데이터를 생성하며, 인덱스는 <code>Sys.Date()</code>를 통해 현재 날짜를 입력합니다.</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(httr)
<span class="kw">library</span>(rvest)

url =<span class="st"> </span><span class="kw">paste0</span>(
  <span class="st">&#39;https://fchart.stock.naver.com/sise.nhn?symbol=&#39;</span>,
  name,<span class="st">&#39;&amp;timeframe=day&amp;count=500&amp;requestType=0&#39;</span>)
data =<span class="st"> </span><span class="kw">GET</span>(url)
data_html =<span class="st"> </span><span class="kw">read_html</span>(data, <span class="dt">encoding =</span> <span class="st">&#39;EUC-KR&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_nodes</span>(<span class="st">&#39;item&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_attr</span>(<span class="st">&#39;data&#39;</span>) 

<span class="kw">print</span>(<span class="kw">head</span>(data_html))</code></pre>
<pre><code>## [1] &quot;20180105|51300|52120|51200|52120|189623&quot;
## [2] &quot;20180108|52400|52520|51500|52020|167673&quot;
## [3] &quot;20180109|51460|51720|49980|50400|360272&quot;
## [4] &quot;20180110|50500|50520|48640|48840|371336&quot;
## [5] &quot;20180111|48200|49260|48020|48240|502476&quot;
## [6] &quot;20180112|48240|48480|46760|48200|545409&quot;</code></pre>
<ol style="list-style-type: decimal">
<li><code>paste0()</code> 함수를 이용해 원하는 종목의 url을 생성합니다. url 중 티커에 해당하는 6자리 부분만 위에서 입력한 name으로 설정해주면 됩니다.</li>
<li><code>GET()</code> 함수를 통해 페이지의 데이터를 불러옵니다.</li>
<li><code>read_html()</code> 함수를 통해 HTML 정보를 읽어옵니다.</li>
<li><code>html_nodes()</code>와 <code>html_attr()</code> 함수를 통해 item 태그 및 data 속성의 데이터를 추출합니다.</li>
</ol>
<p>결과적으로 날짜 및 주가, 거래량 데이터가 추출됩니다. 해당 데이터는 |으로 구분되어 있으며, 이를 테이블 형태로 바꿀 필요가 있습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(readr)

price =<span class="st"> </span><span class="kw">read_delim</span>(data_html, <span class="dt">delim =</span> <span class="st">&#39;|&#39;</span>)
<span class="kw">print</span>(<span class="kw">head</span>(price))</code></pre>
<pre><code>## # A tibble: 6 x 6
##   `20180105` `51300` `52120` `51200` `52120_1` `189623`
##        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1   20180108   52400   52520   51500     52020   167673
## 2   20180109   51460   51720   49980     50400   360272
## 3   20180110   50500   50520   48640     48840   371336
## 4   20180111   48200   49260   48020     48240   502476
## 5   20180112   48240   48480   46760     48200   545409
## 6   20180115   48800   48980   47920     48540   201920</code></pre>
<p>readr 패키지의 <code>read_delim()</code> 함수를 쓰면 구분자로 이루어진 데이터를 테이블로 쉽게 변경할 수 있습니다. 데이터를 확인해보면 테이블 형태로 변경되었으며 각 열은 날짜, 시가, 고가, 저가, 종가, 거래량을 의미합니다. 이 중 우리가 필요한 날짜와 종가를 선택한 후 데이터 클렌징을 해줍니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lubridate)
<span class="kw">library</span>(timetk)

price =<span class="st"> </span>price[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)] 
price =<span class="st"> </span><span class="kw">data.frame</span>(price)
<span class="kw">colnames</span>(price) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Date&#39;</span>, <span class="st">&#39;Price&#39;</span>)
price[, <span class="dv">1</span>] =<span class="st"> </span><span class="kw">ymd</span>(price[, <span class="dv">1</span>])
price =<span class="st"> </span><span class="kw">tk_xts</span>(price, <span class="dt">date_var =</span> Date)
 
<span class="kw">print</span>(<span class="kw">tail</span>(price))</code></pre>
<pre><code>##            Price
## 2020-01-13 60000
## 2020-01-14 60000
## 2020-01-15 59000
## 2020-01-16 60700
## 2020-01-17 61300
## 2020-01-20 62400</code></pre>
<ol style="list-style-type: decimal">
<li>날짜에 해당하는 첫 번째 열과, 종가에 해당하는 다섯 번째 열만 선택해 저장합니다.</li>
<li>티블 형태의 데이터를 데이터 프레임 형태로 변경합니다.</li>
<li>열 이름을 Date와 Price로 변경합니다.</li>
<li>lubridate 패키지의 <code>ymd()</code> 함수를 이용하면 yyyymmdd 형태가 yyyy-mm-dd로 변경되며 데이터 형태 또한 Date 타입으로 변경됩니다.</li>
<li><code>timetk</code> 패키지의 <code>tk_xts()</code> 함수를 이용해 시계열 형태로 변경하며, 인덱스는 Date 열을 설정합니다. 형태를 변경한 후 해당 열은 자동으로 삭제됩니다.</li>
</ol>
<p>데이터를 확인해보면 우리에게 필요한 형태로 정리되었습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv</span>(price, <span class="kw">paste0</span>(<span class="st">&#39;data/KOR_price/&#39;</span>, name,
                        <span class="st">&#39;_price.csv&#39;</span>))</code></pre>
<p>마지막으로 해당 데이터를 data 폴더의 KOR_price 폴더 내에 티커_price.csv 이름으로 저장합니다.</p>
</div>
<div id="section-32" class="section level3">
<h3><span class="header-section-number">6.1.2</span> 전 종목 주가 크롤링</h3>
<p>위의 코드에서 for loop 구문을 이용해 i 값만 변경해주면 모든 종목의 주가를 다운로드할 수 있습니다. 전 종목 주가를 다운로드하는 전체 코드는 다음과 같습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(httr)
<span class="kw">library</span>(rvest)
<span class="kw">library</span>(stringr)
<span class="kw">library</span>(xts)
<span class="kw">library</span>(lubridate)
<span class="kw">library</span>(readr)

KOR_ticker =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;data/KOR_ticker.csv&#39;</span>, <span class="dt">row.names =</span> <span class="dv">1</span>)
<span class="kw">print</span>(KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span>[<span class="dv">1</span>])
KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span> =
<span class="st">  </span><span class="kw">str_pad</span>(KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span>, <span class="dv">6</span>, <span class="dt">side =</span> <span class="kw">c</span>(<span class="st">&#39;left&#39;</span>), <span class="dt">pad =</span> <span class="st">&#39;0&#39;</span>)

<span class="kw">ifelse</span>(<span class="kw">dir.exists</span>(<span class="st">&#39;data/KOR_price&#39;</span>), <span class="ot">FALSE</span>,
       <span class="kw">dir.create</span>(<span class="st">&#39;data/KOR_price&#39;</span>))

<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span> <span class="op">:</span><span class="st"> </span><span class="kw">nrow</span>(KOR_ticker) ) {
  
  price =<span class="st"> </span><span class="kw">xts</span>(<span class="ot">NA</span>, <span class="dt">order.by =</span> <span class="kw">Sys.Date</span>()) <span class="co"># 빈 시계열 데이터 생성</span>
  name =<span class="st"> </span>KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span>[i] <span class="co"># 티커 부분 선택</span>
  
  <span class="co"># 오류 발생 시 이를 무시하고 다음 루프로 진행</span>
  <span class="kw">tryCatch</span>({
    <span class="co"># url 생성</span>
    url =<span class="st"> </span><span class="kw">paste0</span>(
      <span class="st">&#39;https://fchart.stock.naver.com/sise.nhn?symbol=&#39;</span>
      ,name,<span class="st">&#39;&amp;timeframe=day&amp;count=500&amp;requestType=0&#39;</span>)
    
    <span class="co"># 이 후 과정은 위와 동일함</span>
    <span class="co"># 데이터 다운로드</span>
    data =<span class="st"> </span><span class="kw">GET</span>(url)
    data_html =<span class="st"> </span><span class="kw">read_html</span>(data, <span class="dt">encoding =</span> <span class="st">&#39;EUC-KR&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">html_nodes</span>(<span class="st">&quot;item&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">html_attr</span>(<span class="st">&quot;data&quot;</span>) 
    
    <span class="co"># 데이터 나누기</span>
    price =<span class="st"> </span><span class="kw">read_delim</span>(data_html, <span class="dt">delim =</span> <span class="st">&#39;|&#39;</span>)
    
    <span class="co"># 필요한 열만 선택 후 클렌징</span>
    price =<span class="st"> </span>price[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)] 
    price =<span class="st"> </span><span class="kw">data.frame</span>(price)
    <span class="kw">colnames</span>(price) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Date&#39;</span>, <span class="st">&#39;Price&#39;</span>)
    price[, <span class="dv">1</span>] =<span class="st"> </span><span class="kw">ymd</span>(price[, <span class="dv">1</span>])
    
    <span class="kw">rownames</span>(price) =<span class="st"> </span>price[, <span class="dv">1</span>]
    price[, <span class="dv">1</span>] =<span class="st"> </span><span class="ot">NULL</span>
    
  }, <span class="dt">error =</span> <span class="cf">function</span>(e) {
    
    <span class="co"># 오류 발생시 해당 종목명을 출력하고 다음 루프로 이동</span>
    <span class="kw">warning</span>(<span class="kw">paste0</span>(<span class="st">&quot;Error in Ticker: &quot;</span>, name))
  })
  
  <span class="co"># 다운로드 받은 파일을 생성한 폴더 내 csv 파일로 저장</span>
  <span class="kw">write.csv</span>(price, <span class="kw">paste0</span>(<span class="st">&#39;data/KOR_price/&#39;</span>, name,
                          <span class="st">&#39;_price.csv&#39;</span>))
  
  <span class="co"># 타임슬립 적용</span>
  <span class="kw">Sys.sleep</span>(<span class="dv">2</span>)
}</code></pre>
<p>위 코드에서 추가된 점은 다음과 같습니다. 페이지 오류, 통신 오류 등 오류가 발생할 경우 for loop 구문은 멈춰버리는데 전체 데이터를 처음부터 다시 받는 일은 매우 귀찮은 작업입니다. 따라서 <code>tryCatch()</code> 함수를 이용해 오류가 발생할 때 해당 티커를 출력한 후 다음 루프로 넘어가게 합니다.</p>
<p>또한 오류가 발생하면 <code>xts()</code> 함수를 통해 만들어둔 빈 데이터를 저장하게 됩니다. 마지막으로 무한 크롤링을 방지하기 위해 한 번의 루프가 끝날 때마다 2초의 타임슬립을 적용했습니다.</p>
<p>위 코드가 모두 돌아가는 데는 수 시간이 걸립니다. 작업이 끝난 후 data/KOR_price 폴더를 확인해보면 전 종목 주가가 csv 형태로 저장되어 있습니다.</p>
</div>
</div>
<div id="section-33" class="section level2">
<h2><span class="header-section-number">6.2</span> 재무제표 및 가치지표 크롤링</h2>
<p>주가와 더불어 재무제표와 가치지표 역시 투자에 있어 핵심이 되는 데이터입니다. 해당 데이터 역시 여러 웹사이트에서 구할 수 있지만, 국내 데이터 제공업체인 FnGuide에서 운영하는 Company Guide 웹사이트<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a>에서 손쉽게 구할 수 있습니다.</p>
<div id="section-34" class="section level3">
<h3><span class="header-section-number">6.2.1</span> 재무제표 다운로드</h3>
<p>먼저 개별종목의 재무제표를 탭을 선택하면 포괄손익계산서, 재무상태표, 현금흐름표 항목이 보이게 되며, 티커에 해당하는 A005930 뒤의 주소는 불필요한 내용이므로, 이를 제거한 주소로 접속합니다. A 뒤의 6자리 티커만 변경한다면 해당 종목의 재무제표 페이지로 이동하게 됩니다.</p>
<p><strong><a href="http://comp.fnguide.com/SVO2/ASP/SVD_Finance.asp?pGB=1&amp;gicode=A005930" class="uri">http://comp.fnguide.com/SVO2/ASP/SVD_Finance.asp?pGB=1&amp;gicode=A005930</a></strong></p>
<p>우리가 원하는 재무제표 항목들은 모두 테이블 형태로 제공되고 있으므로 html_table() 함수를 이용해 추출할 수 있습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(httr)
<span class="kw">library</span>(rvest)

<span class="kw">ifelse</span>(<span class="kw">dir.exists</span>(<span class="st">&#39;data/KOR_fs&#39;</span>), <span class="ot">FALSE</span>,
       <span class="kw">dir.create</span>(<span class="st">&#39;data/KOR_fs&#39;</span>))

<span class="kw">Sys.setlocale</span>(<span class="st">&quot;LC_ALL&quot;</span>, <span class="st">&quot;English&quot;</span>)

url =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;http://comp.fnguide.com/SVO2/ASP/SVD_Finance.asp?pGB=1&amp;gicode=A005930&#39;</span>)

data =<span class="st"> </span><span class="kw">GET</span>(url)
data =<span class="st"> </span>data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">read_html</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_table</span>()

<span class="kw">Sys.setlocale</span>(<span class="st">&quot;LC_ALL&quot;</span>, <span class="st">&quot;Korean&quot;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lapply</span>(data, <span class="cf">function</span>(x) {
  <span class="kw">head</span>(x, <span class="dv">3</span>)})</code></pre>
<pre><code>## [[1]]
##   IFRS(연결)   2016/12   2017/12   2018/12   2019/09  전년동기 전년동기(%)
## 1     매출액 2,018,667 2,395,754 2,437,714 1,705,161 1,845,064        -7.6
## 2   매출원가 1,202,777 1,292,907 1,323,944 1,086,850   983,784        10.5
## 3 매출총이익   815,890 1,102,847 1,113,770   618,311   861,279       -28.2
## 
## [[2]]
##   IFRS(연결) 2018/12 2019/03 2019/06 2019/09 전년동기 전년동기(%)
## 1     매출액 592,651 523,855 561,271 620,035  654,600        -5.3
## 2   매출원가 340,160 327,465 359,447 399,939  351,944        13.6
## 3 매출총이익 252,491 196,391 201,824 220,096  302,656       -27.3
## 
## [[3]]
##                          IFRS(연결)   2016/12   2017/12   2018/12
## 1                              자산 2,621,743 3,017,521 3,393,572
## 2 유동자산계산에 참여한 계정 펼치기 1,414,297 1,469,825 1,746,974
## 3                          재고자산   183,535   249,834   289,847
##     2019/09
## 1 3,533,860
## 2 1,860,421
## 3   309,088
## 
## [[4]]
##                          IFRS(연결)   2018/12   2019/03   2019/06
## 1                              자산 3,393,572 3,450,679 3,429,401
## 2 유동자산계산에 참여한 계정 펼치기 1,746,974 1,773,885 1,734,335
## 3                          재고자산   289,847   314,560   312,470
##     2019/09
## 1 3,533,860
## 2 1,860,421
## 3   309,088
## 
## [[5]]
##                     IFRS(연결) 2016/12 2017/12 2018/12 2019/09
## 1     영업활동으로인한현금흐름 473,856 621,620 670,319 256,658
## 2                   당기순손익 227,261 421,867 443,449 165,118
## 3 법인세비용차감전계속사업이익                                
## 
## [[6]]
##                     IFRS(연결) 2018/12 2019/03 2019/06 2019/09
## 1     영업활동으로인한현금흐름 224,281  52,443  65,949 138,266
## 2                   당기순손익  84,622  50,436  51,806  62,877
## 3 법인세비용차감전계속사업이익</code></pre>
<ol style="list-style-type: decimal">
<li>data 폴더 내에 KOR_fs 폴더를 생성합니다.</li>
<li><code>Sys.setlocale()</code> 함수를 통해 로케일 언어를 English로 설정합니다.</li>
<li>url을 입력한 후 <code>GET()</code> 함수를 통해 페이지 내용을 받아옵니다.</li>
<li><code>read_html()</code> 함수를 통해 HTML 내용을 읽어오며, <code>html_table()</code> 함수를 통해 테이블 내용만 추출합니다.</li>
<li>로케일 언어를 다시 Korean으로 설정합니다.</li>
</ol>
<p>위의 과정을 거치면 data 변수에는 리스트 형태로 총 6개의 테이블이 들어오게 되며, 그 내용은 표 <a href="section-29.html#tab:fstable">6.1</a>와 같습니다.</p>
<table>
<caption><span id="tab:fstable">표 6.1: </span>재무제표 테이블 내역</caption>
<thead>
<tr class="header">
<th align="center">순서</th>
<th align="center">내용</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">포괄손익계산서 (연간)</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">포괄손익계산서 (분기)</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">재무상태표 (연간)</td>
</tr>
<tr class="even">
<td align="center">4</td>
<td align="center">재무상태표 (분기)</td>
</tr>
<tr class="odd">
<td align="center">5</td>
<td align="center">현금흐름표 (연간)</td>
</tr>
<tr class="even">
<td align="center">6</td>
<td align="center">현금흐름표 (분기)</td>
</tr>
</tbody>
</table>
<p>이 중 연간 기준 재무제표에 해당하는 첫 번째, 세 번째, 다섯 번째 테이블을 선택합니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">data_IS =<span class="st"> </span>data[[<span class="dv">1</span>]]
data_BS =<span class="st"> </span>data[[<span class="dv">3</span>]]
data_CF =<span class="st"> </span>data[[<span class="dv">5</span>]]

<span class="kw">print</span>(<span class="kw">names</span>(data_IS))</code></pre>
<pre><code>## [1] &quot;IFRS(연결)&quot;  &quot;2016/12&quot;     &quot;2017/12&quot;     &quot;2018/12&quot;     &quot;2019/09&quot;    
## [6] &quot;전년동기&quot;    &quot;전년동기(%)&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">data_IS =<span class="st"> </span>data_IS[, <span class="dv">1</span><span class="op">:</span>(<span class="kw">ncol</span>(data_IS)<span class="op">-</span><span class="dv">2</span>)]</code></pre>
<p>포괄손익계산서 테이블(data_IS)에는 전년동기, 전년동기(%) 열이 있는데 통일성을 위해 해당 열을 삭제합니다. 이제 테이블을 묶은 후 클렌징하겠습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">data_fs =<span class="st"> </span><span class="kw">rbind</span>(data_IS, data_BS, data_CF)
data_fs[, <span class="dv">1</span>] =<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&#39;계산에 참여한 계정 펼치기&#39;</span>,
                    <span class="st">&#39;&#39;</span>, data_fs[, <span class="dv">1</span>])
data_fs =<span class="st"> </span>data_fs[<span class="op">!</span><span class="kw">duplicated</span>(data_fs[, <span class="dv">1</span>]), ]

<span class="kw">rownames</span>(data_fs) =<span class="st"> </span><span class="ot">NULL</span>
<span class="kw">rownames</span>(data_fs) =<span class="st"> </span>data_fs[, <span class="dv">1</span>]
data_fs[, <span class="dv">1</span>] =<span class="st"> </span><span class="ot">NULL</span>

data_fs =<span class="st"> </span>data_fs[, <span class="kw">substr</span>(<span class="kw">colnames</span>(data_fs), <span class="dv">6</span>,<span class="dv">7</span>) <span class="op">==</span><span class="st"> &#39;12&#39;</span>]</code></pre>
<ol style="list-style-type: decimal">
<li><code>rbind()</code> 함수를 이용해 세 테이블을 행으로 묶은 후 data_fs에 저장합니다.</li>
<li>첫 번째 열인 계정명에는 ‘계산에 참여한 계정 펼치기’라는 글자가 들어간 항목이 있습니다. 이는 페이지 내에서 펼치기 역할을 하는 (+) 항목에 해당하며 <code>gsub()</code> 함수를 이용해 해당 글자를 삭제합니다.</li>
<li>중복되는 계정명이 다수 있는데 대부분 불필요한 항목입니다. <code>!duplicated()</code> 함수를 사용해 중복되지 않는 계정명만 선택합니다.</li>
<li>행 이름을 초기화한 후 첫 번째 열의 계정명을 행 이름으로 변경합니다. 그 후 첫 번째 열은 삭제합니다.</li>
<li>간혹 12월 결산법인이 아닌 종목이거나 연간 재무제표임에도 불구하고 분기 재무제표가 들어간 경우가 있습니다. 비교의 통일성을 위해 <code>substr()</code> 함수를 이용해 끝 글자가 12인 열, 즉 12월 결산 데이터만 선택합니다.</li>
</ol>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">head</span>(data_fs))</code></pre>
<pre><code>##                    2016/12   2017/12   2018/12
## 매출액           2,018,667 2,395,754 2,437,714
## 매출원가         1,202,777 1,292,907 1,323,944
## 매출총이익         815,890 1,102,847 1,113,770
## 판매비와관리비     523,484   566,397   524,903
## 인건비              59,763    67,972    64,514
## 유무형자산상각비    10,018    13,366    14,477</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sapply</span>(data_fs, typeof)</code></pre>
<pre><code>##     2016/12     2017/12     2018/12 
## &quot;character&quot; &quot;character&quot; &quot;character&quot;</code></pre>
<p>데이터를 확인해보면 연간 기준 재무제표가 정리되었습니다. 문자형 데이터이므로 숫자형으로 변경합니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)

data_fs =<span class="st"> </span><span class="kw">sapply</span>(data_fs, <span class="cf">function</span>(x) {
  <span class="kw">str_replace_all</span>(x, <span class="st">&#39;,&#39;</span>, <span class="st">&#39;&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">as.numeric</span>()
}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">data.frame</span>(., <span class="dt">row.names =</span> <span class="kw">rownames</span>(data_fs))

<span class="kw">print</span>(<span class="kw">head</span>(data_fs))</code></pre>
<pre><code>##                  X2016.12 X2017.12 X2018.12
## 매출액            2018667  2395754  2437714
## 매출원가          1202777  1292907  1323944
## 매출총이익         815890  1102847  1113770
## 판매비와관리비     523484   566397   524903
## 인건비              59763    67972    64514
## 유무형자산상각비    10018    13366    14477</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sapply</span>(data_fs, typeof)</code></pre>
<pre><code>## X2016.12 X2017.12 X2018.12 
## &quot;double&quot; &quot;double&quot; &quot;double&quot;</code></pre>
<ol style="list-style-type: decimal">
<li><code>sapply()</code> 함수를 이용해 각 열에 stringr 패키지의 <code>str_replace_allr()</code> 함수를 적용해 콤마(,)를 제거한 후 <code>as.numeric()</code> 함수를 통해 숫자형 데이터로 변경합니다.</li>
<li><code>data.frame()</code> 함수를 이용해 데이터 프레임 형태로 만들어주며, 행 이름은 기존 내용을 그대로 유지합니다.</li>
</ol>
<p>정리된 데이터를 출력해보면 문자형이던 데이터가 숫자형으로 변경되었습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv</span>(data_fs, <span class="st">&#39;data/KOR_fs/005930_fs.csv&#39;</span>)</code></pre>
<p>data 폴더의 KOR_fs 폴더 내에 티커_fs.csv 이름으로 저장합니다.</p>
</div>
<div id="section-35" class="section level3">
<h3><span class="header-section-number">6.2.2</span> 가치지표 계산하기</h3>
<p>위에서 구한 재무제표 데이터를 이용해 가치지표를 계산할 수 있습니다. 흔히 사용되는 가치지표는 <strong>PER, PBR, PCR, PSR</strong>이며 분자는 주가, 분모는 재무제표 데이터가 사용됩니다.</p>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-19">표 6.2: </span>가치지표의 종류
</caption>
<thead>
<tr>
<th style="text-align:center;">
순서
</th>
<th style="text-align:center;">
분모
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
PER
</td>
<td style="text-align:center;">
Earnings (순이익)
</td>
</tr>
<tr>
<td style="text-align:center;">
PBR
</td>
<td style="text-align:center;">
Book Value (순자산)
</td>
</tr>
<tr>
<td style="text-align:center;">
PCR
</td>
<td style="text-align:center;">
Cashflow (영업활동현금흐름)
</td>
</tr>
<tr>
<td style="text-align:center;">
PSR
</td>
<td style="text-align:center;">
Sales (매출액)
</td>
</tr>
</tbody>
</table>
<p>위에서 구한 재무제표 항목에서 분모 부분에 해당하는 데이터만 선택해보겠습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ifelse</span>(<span class="kw">dir.exists</span>(<span class="st">&#39;data/KOR_value&#39;</span>), <span class="ot">FALSE</span>,
       <span class="kw">dir.create</span>(<span class="st">&#39;data/KOR_value&#39;</span>))</code></pre>
<pre><code>## [1] FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">value_type =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;지배주주순이익&#39;</span>,
               <span class="st">&#39;자본&#39;</span>,
               <span class="st">&#39;영업활동으로인한현금흐름&#39;</span>,
               <span class="st">&#39;매출액&#39;</span>)

value_index =<span class="st"> </span>data_fs[<span class="kw">match</span>(value_type, <span class="kw">rownames</span>(data_fs)),
                      <span class="kw">ncol</span>(data_fs)]
<span class="kw">print</span>(value_index)</code></pre>
<pre><code>## [1]  438909 2477532  670319 2437714</code></pre>
<ol style="list-style-type: decimal">
<li>data 폴더 내에 KOR_value 폴더를 생성합니다.</li>
<li>분모에 해당하는 항목을 저장한 후 <code>match()</code> 함수를 이용해 해당 항목이 위치하는 지점을 찾습니다. <code>ncol()</code> 함수를 이용해 맨 오른쪽, 즉 최근년도 재무제표 데이터를 선택합니다.</li>
</ol>
<p>다음으로 분자 부분에 해당하는 현재 주가를 수집해야 합니다. 이 역시 Company Guide 접속 화면에서 구할 수 있습니다. 불필요한 부분을 제거한 URL은 다음과 같습니다.</p>
<p><strong><a href="http://comp.fnguide.com/SVO2/ASP/SVD_main.asp?pGB=1&amp;gicode=A005930" class="uri">http://comp.fnguide.com/SVO2/ASP/SVD_main.asp?pGB=1&amp;gicode=A005930</a></strong></p>
<p>위의 주소 역시 A 뒤의 6자리 티커만 변경하면 해당 종목의 스냅샷 페이지로 이동하게 됩니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-21"></span>
<img src="images/crawl_practice_comp_price.png" alt="Company Guide 스냅샷 화면" width="70%" />
<p class="caption">
그림 4.5: Company Guide 스냅샷 화면
</p>
</div>
<p>주가추이 부분에 우리가 원하는 현재 주가가 있습니다. 해당 데이터의 Xpath는 다음과 같습니다.</p>
<pre class="sourceCode css"><code class="sourceCode css"><span class="er">//*[@id=&quot;svdMainChartTxt11&quot;]</span></code></pre>
<style type="text/css">
//*[@id="svdMainChartTxt11"]
</style>
<p>위에서 구한 주가의 Xpath를 이용해 해당 데이터를 크롤링하겠습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(readr)

url =<span class="st"> &#39;http://comp.fnguide.com/SVO2/ASP/SVD_main.asp?pGB=1&amp;gicode=A005930&#39;</span>
data =<span class="st"> </span><span class="kw">GET</span>(url)

price =<span class="st"> </span><span class="kw">read_html</span>(data) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_node</span>(<span class="dt">xpath =</span> <span class="st">&#39;//*[@id=&quot;svdMainChartTxt11&quot;]&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">parse_number</span>()

<span class="kw">print</span>(price)</code></pre>
<pre><code>## [1] 61300</code></pre>
<ol style="list-style-type: decimal">
<li>url을 입력한 후, <code>GET()</code> 함수를 이용해 데이터를 불러옵니다.</li>
<li><code>read_html()</code> 함수를 이용해 HTML 데이터를 불러온 후 <code>html_node()</code> 함수에 앞서 구한 Xpath를 입력해 해당 지점의 데이터를 추출합니다.</li>
<li><code>html_text()</code> 함수를 통해 텍스트 데이터만을 추출하며, readr 패키지의 <code>parse_number()</code> 함수를 적용합니다. 해당 함수는 문자형 데이터에서 콤마와 같은 불필요한 문자를 제거한 후 숫자형 데이터로 변경해줍니다.</li>
</ol>
<p>가치지표를 계산하려면 발행주식수 역시 필요합니다. 예를 들어 PER를 계산하는 방법은 다음과 같습니다.</p>
<p><span class="math display">\[ PER = Price / EPS  = 주가 / 주당순이익\]</span></p>
<p>주당순이익은 순이익을 전체 주식수로 나눈 값이므로, 해당 값의 계산하려면 전체 주식수를 구해야 합니다. 전체 주식수 데이터 역시 웹페이지에 있으므로 앞서 주가를 크롤링한 방법과 동일한 방법으로 구할 수 있습니다. 전체 주식수 데이터의 Xpath는 다음과 같습니다.</p>
<pre class="sourceCode css"><code class="sourceCode css"><span class="er">//*[@id=&quot;svdMainGrid1&quot;]/table/tbody/tr[7]/td[1]</span></code></pre>
<style type="text/css">
//*[@id="svdMainGrid1"]/table/tbody/tr[7]/td[1]
</style>
<p>이를 이용해 발행주식수 중 보통주를 선택하는 방법은 다음과 같습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">share =<span class="st"> </span><span class="kw">read_html</span>(data) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_node</span>(
    <span class="dt">xpath =</span>
      <span class="st">&#39;//*[@id=&quot;svdMainGrid1&quot;]/table/tbody/tr[7]/td[1]&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_text</span>()

<span class="kw">print</span>(share)</code></pre>
<pre><code>## [1] &quot;5,969,782,550/ 822,886,700&quot;</code></pre>
<p><code>read_html()</code> 함수와 <code>html_node()</code> 함수를 이용해, HTML 내에서 Xpath에 해당하는 데이터를 추출합니다. 그 후 <code>html_text()</code> 함수를 통해 텍스트 부분만 추출합니다. 해당 과정을 거치면 보통주/우선주의 형태로 발행주식주가 저장됩니다. 이 중 우리가 원하는 데이터는 / 앞에 있는 보통주 발행주식수입니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">share =<span class="st"> </span>share <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">strsplit</span>(<span class="st">&#39;/&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span>
<span class="st">  </span>.[<span class="dv">1</span>] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">parse_number</span>()

<span class="kw">print</span>(share)</code></pre>
<pre><code>## [1] 5969782550</code></pre>
<ol style="list-style-type: decimal">
<li><code>strsplit()</code> 함수를 통해 /를 기준으로 데이터를 나눕니다. 해당 결과는 리스트 형태로 저장됩니다.</li>
<li><code>unlist()</code> 함수를 통해 리스트를 벡터 형태로 변환합니다.</li>
<li><code>.[1]</code>.[1]을 통해 보통주 발행주식수인 첫 번째 데이터를 선택합니다.</li>
<li><code>parse_number()</code> 함수를 통해 문자형 데이터를 숫자형으로 변환합니다.</li>
</ol>
<p>재무 데이터, 현재 주가, 발행주식수를 이용해 가치지표를 계산해보겠습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">data_value =<span class="st"> </span>price <span class="op">/</span><span class="st"> </span>(value_index <span class="op">*</span><span class="st"> </span><span class="dv">100000000</span> <span class="op">/</span><span class="st"> </span>share)
<span class="kw">names</span>(data_value) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;PER&#39;</span>, <span class="st">&#39;PBR&#39;</span>, <span class="st">&#39;PCR&#39;</span>, <span class="st">&#39;PSR&#39;</span>)
data_value[data_value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] =<span class="st"> </span><span class="ot">NA</span>

<span class="kw">print</span>(data_value)</code></pre>
<pre><code>##   PER   PBR   PCR   PSR 
## 8.338 1.477 5.459 1.501</code></pre>
<p>분자에는 현재 주가를 입력하며, 분모에는 재무 데이터를 보통주 발행주식수로 나눈 값을 입력합니다. 단, 주가는 원 단위, 재무 데이터는 억 원 단위이므로, 둘 사이에 단위를 동일하게 맞춰주기 위해 분모에 억을 곱합니다. 또한 가치지표가 음수인 경우는 NA로 변경해줍니다.</p>
<p>결과를 확인해보면 4가지 가치지표가 잘 계산되었습니다.<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv</span>(data_value, <span class="st">&#39;data/KOR_value/005930_value.csv&#39;</span>)</code></pre>
<p>data 폴더의 KOR_value 폴더 내에 티커_value.csv 이름으로 저장합니다.</p>
</div>
<div id="section-36" class="section level3">
<h3><span class="header-section-number">6.2.3</span> 전 종목 재무제표 및 가치지표 다운로드</h3>
<p>위 코드에서 for loop 구문을 이용해 URL 중 6자리 티커에 해당하는 값만 변경해주면 모든 종목의 재무제표를 다운로드하고 이를 바탕으로 가치지표를 계산할 수 있습니다. 해당 코드는 다음과 같습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)
<span class="kw">library</span>(httr)
<span class="kw">library</span>(rvest)
<span class="kw">library</span>(stringr)
<span class="kw">library</span>(readr)

KOR_ticker =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;data/KOR_ticker.csv&#39;</span>, <span class="dt">row.names =</span> <span class="dv">1</span>)
KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span> =
<span class="st">  </span><span class="kw">str_pad</span>(KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span>, <span class="dv">6</span>,<span class="dt">side =</span> <span class="kw">c</span>(<span class="st">&#39;left&#39;</span>), <span class="dt">pad =</span> <span class="st">&#39;0&#39;</span>)

<span class="kw">ifelse</span>(<span class="kw">dir.exists</span>(<span class="st">&#39;data/KOR_fs&#39;</span>), <span class="ot">FALSE</span>,
       <span class="kw">dir.create</span>(<span class="st">&#39;data/KOR_fs&#39;</span>))
<span class="kw">ifelse</span>(<span class="kw">dir.exists</span>(<span class="st">&#39;data/KOR_value&#39;</span>), <span class="ot">FALSE</span>,
       <span class="kw">dir.create</span>(<span class="st">&#39;data/KOR_value&#39;</span>))

<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span> <span class="op">:</span><span class="st"> </span><span class="kw">nrow</span>(KOR_ticker) ) {
  
  data_fs =<span class="st"> </span><span class="kw">c</span>()
  data_value =<span class="st"> </span><span class="kw">c</span>()
  name =<span class="st"> </span>KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span>[i]
  
  <span class="co"># 오류 발생 시 이를 무시하고 다음 루프로 진행</span>
  <span class="kw">tryCatch</span>({
    
    <span class="kw">Sys.setlocale</span>(<span class="st">&#39;LC_ALL&#39;</span>, <span class="st">&#39;English&#39;</span>)
    
    <span class="co"># url 생성</span>
    url =<span class="st"> </span><span class="kw">paste0</span>(
      <span class="st">&#39;http://comp.fnguide.com/SVO2/ASP/&#39;</span>
      ,<span class="st">&#39;SVD_Finance.asp?pGB=1&amp;gicode=A&#39;</span>,
      name)
    
    <span class="co"># 이 후 과정은 위와 동일함</span>
    
    <span class="co"># 데이터 다운로드 후 테이블 추출</span>
    data =<span class="st"> </span><span class="kw">GET</span>(url) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">read_html</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">html_table</span>()
    
    <span class="kw">Sys.setlocale</span>(<span class="st">&#39;LC_ALL&#39;</span>, <span class="st">&#39;Korean&#39;</span>)
    
    <span class="co"># 3개 재무제표를 하나로 합치기</span>
    data_IS =<span class="st"> </span>data[[<span class="dv">1</span>]]
    data_BS =<span class="st"> </span>data[[<span class="dv">3</span>]]
    data_CF =<span class="st"> </span>data[[<span class="dv">5</span>]]
    
    data_IS =<span class="st"> </span>data_IS[, <span class="dv">1</span><span class="op">:</span>(<span class="kw">ncol</span>(data_IS)<span class="op">-</span><span class="dv">2</span>)]
    data_fs =<span class="st"> </span><span class="kw">rbind</span>(data_IS, data_BS, data_CF)
    
    <span class="co"># 데이터 클랜징</span>
    data_fs[, <span class="dv">1</span>] =<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&#39;계산에 참여한 계정 펼치기&#39;</span>,
                        <span class="st">&#39;&#39;</span>, data_fs[, <span class="dv">1</span>])
    data_fs =<span class="st"> </span>data_fs[<span class="op">!</span><span class="kw">duplicated</span>(data_fs[, <span class="dv">1</span>]), ]
    
    <span class="kw">rownames</span>(data_fs) =<span class="st"> </span><span class="ot">NULL</span>
    <span class="kw">rownames</span>(data_fs) =<span class="st"> </span>data_fs[, <span class="dv">1</span>]
    data_fs[, <span class="dv">1</span>] =<span class="st"> </span><span class="ot">NULL</span>
    
    <span class="co"># 12월 재무제표만 선택</span>
    data_fs =
<span class="st">      </span>data_fs[, <span class="kw">substr</span>(<span class="kw">colnames</span>(data_fs), <span class="dv">6</span>,<span class="dv">7</span>) <span class="op">==</span><span class="st"> &quot;12&quot;</span>]
    
    data_fs =<span class="st"> </span><span class="kw">sapply</span>(data_fs, <span class="cf">function</span>(x) {
      <span class="kw">str_replace_all</span>(x, <span class="st">&#39;,&#39;</span>, <span class="st">&#39;&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">as.numeric</span>()
    }) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">data.frame</span>(., <span class="dt">row.names =</span> <span class="kw">rownames</span>(data_fs))
    
    
    <span class="co"># 가치지표 분모부분</span>
    value_type =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;지배주주순이익&#39;</span>, 
                   <span class="st">&#39;자본&#39;</span>, 
                   <span class="st">&#39;영업활동으로인한현금흐름&#39;</span>, 
                   <span class="st">&#39;매출액&#39;</span>) 
    
    <span class="co"># 해당 재무데이터만 선택</span>
    value_index =<span class="st"> </span>data_fs[<span class="kw">match</span>(value_type, <span class="kw">rownames</span>(data_fs)),
                          <span class="kw">ncol</span>(data_fs)]
    
    <span class="co"># Snapshot 페이지 불러오기</span>
    url =
<span class="st">      </span><span class="kw">paste0</span>(
        <span class="st">&#39;http://comp.fnguide.com/SVO2/ASP/SVD_Main.asp&#39;</span>,
        <span class="st">&#39;?pGB=1&amp;gicode=A&#39;</span>,name)
    data =<span class="st"> </span><span class="kw">GET</span>(url)
    
    <span class="co"># 현재 주가 크롤링</span>
    price =<span class="st"> </span><span class="kw">read_html</span>(data) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">html_node</span>(<span class="dt">xpath =</span> <span class="st">&#39;//*[@id=&quot;svdMainChartTxt11&quot;]&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">parse_number</span>()
    
    <span class="co"># 보통주 발행장주식수 크롤링</span>
    share =<span class="st"> </span><span class="kw">read_html</span>(data) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">html_node</span>(
        <span class="dt">xpath =</span>
        <span class="st">&#39;//*[@id=&quot;svdMainGrid1&quot;]/table/tbody/tr[7]/td[1]&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">strsplit</span>(<span class="st">&#39;/&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span>
<span class="st">      </span>.[<span class="dv">1</span>] <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">parse_number</span>()
    
    <span class="co"># 가치지표 계산</span>
    data_value =<span class="st"> </span>price <span class="op">/</span><span class="st"> </span>(value_index <span class="op">*</span><span class="st"> </span><span class="dv">100000000</span><span class="op">/</span><span class="st"> </span>share)
    <span class="kw">names</span>(data_value) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;PER&#39;</span>, <span class="st">&#39;PBR&#39;</span>, <span class="st">&#39;PCR&#39;</span>, <span class="st">&#39;PSR&#39;</span>)
    data_value[data_value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] =<span class="st"> </span><span class="ot">NA</span>
    
  }, <span class="dt">error =</span> <span class="cf">function</span>(e) {
    
    <span class="co"># 오류 발생시 해당 종목명을 출력하고 다음 루프로 이동</span>
    data_fs &lt;&lt;-<span class="st"> </span><span class="ot">NA</span>
    data_value &lt;&lt;-<span class="st"> </span><span class="ot">NA</span>
    <span class="kw">warning</span>(<span class="kw">paste0</span>(<span class="st">&quot;Error in Ticker: &quot;</span>, name))
  })
  
  <span class="co"># 다운로드 받은 파일을 생성한 각각의 폴더 내 csv 파일로 저장</span>
  
  <span class="co"># 재무제표 저장</span>
  <span class="kw">write.csv</span>(data_fs, <span class="kw">paste0</span>(<span class="st">&#39;data/KOR_fs/&#39;</span>, name, <span class="st">&#39;_fs.csv&#39;</span>))
  
  <span class="co"># 가치지표 저장</span>
  <span class="kw">write.csv</span>(data_value, <span class="kw">paste0</span>(<span class="st">&#39;data/KOR_value/&#39;</span>, name,
                               <span class="st">&#39;_value.csv&#39;</span>))
  
  <span class="co"># 2초간 타임슬립 적용</span>
  <span class="kw">Sys.sleep</span>(<span class="dv">2</span>)
}</code></pre>
<p>전 종목 주가 데이터를 받는 과정과 동일하게 KOR_ticker.csv 파일을 불러온 후 for loop를 통해 i 값이 변함에 따라 티커를 변경해가며 모든 종목의 재무제표 및 가치지표를 다운로드합니다. <code>tryCatch()</code> 함수를 이용해 오류가 발생하면 NA로 이루어진 빈 데이터를 저장한 후 다음 루프로 넘어가게 됩니다. data/KOR_fs 폴더에는 전 종목의 재무제표 데이터가 저장되고, data/KOR_value 폴더에는 전 종목의 가치지표 데이터가 csv 형태로 저장됩니다.</p>
</div>
</div>
<div id="dart--" class="section level2">
<h2><span class="header-section-number">6.3</span> DART 데이터 수집하기</h2>
<p>DART(Data Analysis, Retrieval and Transfer System)는 금융감독원 전자공시시스템으로써, 상장법인 등이 공시서류를 인터넷으로 제출하고, 투자자 등 이용자는 제출 즉시 인터넷을 통해 조회할 수 있도록 하는 종합적 기업공시 시스템입니다.</p>
<p>홈페이지에서도 각종 공시내역을 확인할 수 있지만, 해당 사이트에서 제공하는 API를 이용할 경우 더욱 쉽게 공시 보고서 목록을 크롤링할 수 있습니다.</p>
<div id="section-37" class="section level3">
<h3><span class="header-section-number">6.3.1</span> 인증키 발급받기</h3>
<p>먼저 <a href="http://dart.fss.or.kr" class="uri">http://dart.fss.or.kr</a> 에 접속하여 우측 상단의 [오픈API] 메뉴를 누른 후, 좌측의 [인증키 신청/관리]를 통해 회원가입을 합니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-30"></span>
<img src="images/dart_api.png" alt="오픈API 회원가입" width="70%" />
<p class="caption">
그림 6.1: 오픈API 회원가입
</p>
</div>
<p>[계정신청]을 통해 계정을 만들고 이메일을 통해 이용자 등록을 한 후 로그인을 합니다. 그 후 [개인용 오픈API 인증키 신청]을 통해 API KEY를 발급받습니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-31"></span>
<img src="images/dart_api_private.png" alt="API KEY 발급" width="70%" />
<p class="caption">
그림 6.2: API KEY 발급
</p>
</div>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-32"></span>
<img src="images/dart_api_private2.png" alt="API Key 발급완료" width="70%" />
<p class="caption">
그림 6.3: API Key 발급완료
</p>
</div>
<p>개인용 API의 경우 하루에 총 10,000회 데이터를 요청할 수 있으며, 일분마다 한번씩 요청해도 될 정도로 넉넉한 횟수입니다.</p>
<p>발급받은 인증키를 관리하기 위해 <code>.Renviron</code> 파일을 이용합니다. <code>file.edit("~/.Renviron")</code> 명령어를 통해 <code>.Renviron</code> 파일을 연 후, 다음과 같이 인증키를 입력합니다.</p>
<pre><code>dart_api_key = &#39;YOUR API KEY&#39;</code></pre>
<p><strong><code>.Renviron</code> 파일의 적용을 위해 R을 재시작</strong>한 후, 다음 코드를 통해 인증키를 불러옵니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">dart_api =<span class="st"> </span><span class="kw">Sys.getenv</span>(<span class="st">&quot;dart_api_key&quot;</span>)</code></pre>
</div>
<div id="section-38" class="section level3">
<h3><span class="header-section-number">6.3.2</span> 오늘의 공시 확인하기</h3>
<p>홈페이지 좌측의 [오픈API 개발가이드] 메뉴를 통해 원하는 항목의 요청 주소를 알 수 있습니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-34"></span>
<img src="images/dart_api_sample.png" alt="검색API 샘플" width="70%" />
<p class="caption">
그림 6.4: 검색API 샘플
</p>
</div>
<p>이 중 auth= 뒤의 xxx는 위에서 발급 받은 인증키를 의미합니다. 당일 접수 100건에 해당하는 주소는 다음과 같습니다.</p>
<pre><code>http://dart.fss.or.kr/api/search.json?auth=xxx&amp;page_set=100</code></pre>
<p>해당 주소에 해당하는 데이터를 불러오도록 하겠습니다. 위 주소는 xml 형태로 이루어져 있지만, 데이터 가공의 편이성을 위해 json 형태로 데이터를 불러오도록 합니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(jsonlite)

url =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;http://dart.fss.or.kr/api/search.json?auth=&#39;</span>,dart_api,<span class="st">&#39;&amp;page_set=100&#39;</span>)
dart_discl =<span class="st"> </span><span class="kw">fromJSON</span>(url)

<span class="kw">str</span>(dart_discl)</code></pre>
<pre><code>## List of 7
##  $ err_code   : chr &quot;000&quot;
##  $ err_msg    : chr &quot;정상&quot;
##  $ page_no    : int 1
##  $ page_set   : int 100
##  $ total_count: int 411
##  $ total_page : int 5
##  $ list       :&#39;data.frame&#39;: 100 obs. of  8 variables:
##   ..$ crp_cls: chr [1:100] &quot;K&quot; &quot;N&quot; &quot;N&quot; &quot;K&quot; ...
##   ..$ crp_nm : chr [1:100] &quot;라이트론&quot; &quot;휴벡셀&quot; &quot;휴벡셀&quot; &quot;한류AI센터&quot; ...
##   ..$ crp_cd : chr [1:100] &quot;069540&quot; &quot;212310&quot; &quot;212310&quot; &quot;222810&quot; ...
##   ..$ rpt_nm : chr [1:100] &quot;횡령ㆍ배임혐의진행사항&quot; &quot;감자완료&quot; &quot;감자완료&quot; &quot;타법인주식및출자증권처분결정&quot; ...
##   ..$ rcp_no : chr [1:100] &quot;20200120900678&quot; &quot;20200120600674&quot; &quot;20200120600673&quot; &quot;20200120900654&quot; ...
##   ..$ flr_nm : chr [1:100] &quot;라이트론&quot; &quot;휴벡셀&quot; &quot;휴벡셀&quot; &quot;한류AI센터&quot; ...
##   ..$ rcp_dt : chr [1:100] &quot;20200120&quot; &quot;20200120&quot; &quot;20200120&quot; &quot;20200120&quot; ...
##   ..$ rmk    : chr [1:100] &quot;코&quot; &quot;넥&quot; &quot;넥&quot; &quot;코&quot; ...</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">dart_discl_data =<span class="st"> </span>dart_discl<span class="op">$</span>list
<span class="kw">head</span>(dart_discl_data)</code></pre>
<pre><code>##   crp_cls     crp_nm crp_cd
## 1       K   라이트론 069540
## 2       N     휴벡셀 212310
## 3       N     휴벡셀 212310
## 4       K 한류AI센터 222810
## 5       K       코렌 078650
## 6       Y     비티원 101140
##                                                     rpt_nm         rcp_no
## 1                                   횡령ㆍ배임혐의진행사항 20200120900678
## 2                                                 감자완료 20200120600674
## 3                                                 감자완료 20200120600673
## 4                             타법인주식및출자증권처분결정 20200120900654
## 5 [기재정정]매출액또는손익구조30%(대규모법인은15%)이상변동 20200120900653
## 6                                         주주총회소집결의 20200120800652
##       flr_nm   rcp_dt rmk
## 1   라이트론 20200120  코
## 2     휴벡셀 20200120  넥
## 3     휴벡셀 20200120  넥
## 4 한류AI센터 20200120  코
## 5       코렌 20200120  코
## 6     비티원 20200120  유</code></pre>
<ol style="list-style-type: decimal">
<li>인증키를 이용하여 url을 생성합니다.</li>
<li><code>fromJSON()</code> 함수를 이용해 JSON 데이터를 불러옵니다.</li>
<li>공시 데이터가 존재하는 $list 부분만 추출하여 dart_discl_data에 저장합니다.</li>
</ol>
<p><a href="http://dart.fss.or.kr/dsaf001/main.do?rcpNo=" class="uri">http://dart.fss.or.kr/dsaf001/main.do?rcpNo=</a> 뒤에 공시번호인 rcp_no를 입력할 경우 이에 해당하는 페이지로 이동할 수 있습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">discl_url =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;http://dart.fss.or.kr/dsaf001/main.do?rcpNo=&#39;</span>, dart_discl_data<span class="op">$</span>rcp_no)
<span class="kw">head</span>(discl_url)</code></pre>
<pre><code>## [1] &quot;http://dart.fss.or.kr/dsaf001/main.do?rcpNo=20200120900678&quot;
## [2] &quot;http://dart.fss.or.kr/dsaf001/main.do?rcpNo=20200120600674&quot;
## [3] &quot;http://dart.fss.or.kr/dsaf001/main.do?rcpNo=20200120600673&quot;
## [4] &quot;http://dart.fss.or.kr/dsaf001/main.do?rcpNo=20200120900654&quot;
## [5] &quot;http://dart.fss.or.kr/dsaf001/main.do?rcpNo=20200120900653&quot;
## [6] &quot;http://dart.fss.or.kr/dsaf001/main.do?rcpNo=20200120800652&quot;</code></pre>
<p>첫번째 url에 접속하여 해당 공시내역을 확인해봅니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-38"></span>
<img src="images/dart_api_web.png" alt="공시내역 확인" width="70%" />
<p class="caption">
그림 6.5: 공시내역 확인
</p>
</div>
<div id="section-39" class="section level4">
<h4><span class="header-section-number">6.3.2.1</span> 관심종목 공시 확인하기</h4>
<p>특정 회사의 당일 접수 10건에 해당하는 url은 다음과 같습니다.</p>
<pre><code>http://dart.fss.or.kr/api/search.json?auth=xxx&amp;crp_cd=xxx</code></pre>
<p>이를 이용해 관심종목들의 오늘자 공시 읽어오도록 합니다. 먼저, 시가총액 상위 30 종목을 관심종목으로 설정합니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)

KOR_ticker =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;data/KOR_ticker.csv&#39;</span>, <span class="dt">row.names =</span> <span class="dv">1</span>)
KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span> =
<span class="st">  </span><span class="kw">str_pad</span>(KOR_ticker<span class="op">$</span><span class="st">&#39;종목코드&#39;</span>, <span class="dv">6</span>, <span class="dt">side =</span> <span class="kw">c</span>(<span class="st">&#39;left&#39;</span>), <span class="dt">pad =</span> <span class="st">&#39;0&#39;</span>)

eq_list =<span class="st"> </span>KOR_ticker[<span class="dv">1</span><span class="op">:</span><span class="dv">30</span>, <span class="st">&#39;종목코드&#39;</span>]
<span class="kw">print</span>(eq_list)</code></pre>
<pre><code>##  [1] &quot;005930&quot; &quot;000660&quot; &quot;035420&quot; &quot;207940&quot; &quot;005380&quot; &quot;012330&quot; &quot;051910&quot;
##  [8] &quot;068270&quot; &quot;051900&quot; &quot;005490&quot; &quot;028260&quot; &quot;105560&quot; &quot;055550&quot; &quot;017670&quot;
## [15] &quot;006400&quot; &quot;015760&quot; &quot;034730&quot; &quot;000270&quot; &quot;018260&quot; &quot;032830&quot; &quot;035720&quot;
## [22] &quot;090430&quot; &quot;036570&quot; &quot;033780&quot; &quot;096770&quot; &quot;003550&quot; &quot;066570&quot; &quot;000810&quot;
## [29] &quot;086790&quot; &quot;009150&quot;</code></pre>
<ol style="list-style-type: decimal">
<li>티커가 저장된 csv 파일을 불러온 후 티커를 6자리로 맞춰줍니다.</li>
<li>상위 30 종목의 코드에 해당하는 열만 선택하여 eq_list에 저장합니다.</li>
</ol>
<p>해당 종목들의 금일 공시를 불러오는 코드는 다음과 같습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">rcp_no_name =<span class="st"> </span><span class="kw">c</span>()
rcp_no_list =<span class="st"> </span><span class="kw">c</span>()

<span class="cf">for</span> (i <span class="cf">in</span> eq_list) {
  
  eq_url =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;http://dart.fss.or.kr/api/search.json?auth=&#39;</span>, dart_api, <span class="st">&#39;&amp;crp_cd=&#39;</span>, i)
  
  eq_discl =<span class="st">  </span><span class="kw">fromJSON</span>(eq_url) 
  eq_discl =<span class="st"> </span>eq_discl<span class="op">$</span>list
  
  eq_title =<span class="st"> </span><span class="kw">paste</span>(eq_discl<span class="op">$</span>crp_nm, eq_discl<span class="op">$</span>rpt_nm)
  eq_rcp_no =<span class="st"> </span>eq_discl<span class="op">$</span>rcp_no
  
  rcp_no_name =<span class="st"> </span><span class="kw">append</span>(rcp_no_name, eq_title)
  rcp_no_list =<span class="st"> </span><span class="kw">append</span>(rcp_no_list, eq_rcp_no)
  
  <span class="kw">Sys.sleep</span>(<span class="dv">1</span>)
  
}

my_discl =<span class="st"> </span><span class="kw">data.frame</span>(rcp_no_name, rcp_no_list)
<span class="kw">print</span>(my_discl)</code></pre>
<ol style="list-style-type: decimal">
<li><code>c()</code>를 통해 종목명과 공시 번호가 들어갈 빈 공간을 만들어 줍니다.</li>
<li>for loop 구문 내에서 인증키와 주식 티커를 이용해 해당 종목의 금일 공시 10건에 해당하는 url을 만들어 줍니다.</li>
<li><code>fromJSON()</code> 함수를 이용해 JSON 데이터를 불러옵니다.</li>
<li>공시 데이터가 존재하는 $list 부분만 추출하여 eq_discl 저장합니다.</li>
<li>종목명인 crp_nm와 공시제목인 rpt_nm을 결합하여 제목을 만든 후 eq_title에 저장합니다.</li>
<li>공시번호에 해당하는 rcp_no 부분을 eq_rcp_no에 저장합니다.</li>
<li><code>append()</code> 함수를 이용해 제목과 공시번호를 쌓아줍니다.</li>
<li>url과 공시번호를 결합하여 공시내역이 있는 url을 생성합니다.</li>
<li>제목과 url 벡터를 데이터프레임 형태로 결합합니다.</li>
</ol>
<p>my_discl에는 관심종목의 금일 공시명과 해당 url이 저장되며, 공시가 없을 경우 아무런 내용도 출력되지 않습니다.</p>
</div>
</div>
<div id="section-40" class="section level3">
<h3><span class="header-section-number">6.3.3</span> 사업보고서의 재무제표 다운로드</h3>
<p>회사의 사업보고서 10건에 해당하는 주소는 다음과 같습니다.</p>
<p><a href="http://dart.fss.or.kr/api/search.json?auth=xxx&amp;crp_cd=xxx&amp;start_dt=19990101&amp;bsn_tp=A001" class="uri">http://dart.fss.or.kr/api/search.json?auth=xxx&amp;crp_cd=xxx&amp;start_dt=19990101&amp;bsn_tp=A001</a></p>
<p>auth는 인증키를, crp_cd는 티커를, start_dt는 시작시점을, bsn_tp는 공시종류에 해당하며 A001은 연간 사업보고서를 의미합니다. 삼성전자(005930)의 사업보고서 10건에 해당하는 API를 요청해보도록 하겠습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">url =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;http://dart.fss.or.kr/api/search.json?auth=&#39;</span>,dart_api,<span class="st">&#39;&amp;crp_cd=005930&amp;start_dt=19990101&amp;bsn_tp=A001&#39;</span>)

dart_data =<span class="st"> </span><span class="kw">fromJSON</span>(url)
<span class="kw">print</span>(dart_data)</code></pre>
<pre><code>## $err_code
## [1] &quot;000&quot;
## 
## $err_msg
## [1] &quot;정상&quot;
## 
## $page_no
## [1] 1
## 
## $page_set
## [1] 10
## 
## $total_count
## [1] 23
## 
## $total_page
## [1] 3
## 
## $list
##    crp_cls   crp_nm crp_cd                         rpt_nm         rcp_no
## 1        Y 삼성전자 005930           사업보고서 (2018.12) 20190401004781
## 2        Y 삼성전자 005930           사업보고서 (2017.12) 20180402005019
## 3        Y 삼성전자 005930           사업보고서 (2016.12) 20170331004518
## 4        Y 삼성전자 005930           사업보고서 (2015.12) 20160330003536
## 5        Y 삼성전자 005930           사업보고서 (2014.12) 20150331002915
## 6        Y 삼성전자 005930           사업보고서 (2013.12) 20140331002427
## 7        Y 삼성전자 005930           사업보고서 (2012.12) 20130401003031
## 8        Y 삼성전자 005930 [첨부추가]사업보고서 (2011.12) 20120330002110
## 9        Y 삼성전자 005930 [첨부추가]사업보고서 (2010.12) 20110331002193
## 10       Y 삼성전자 005930 [첨부추가]사업보고서 (2009.12) 20100331001680
##      flr_nm   rcp_dt rmk
## 1  삼성전자 20190401  연
## 2  삼성전자 20180402  연
## 3  삼성전자 20170331  연
## 4  삼성전자 20160330  연
## 5  삼성전자 20150331  연
## 6  삼성전자 20140331  연
## 7  삼성전자 20130401  연
## 8  삼성전자 20120330  연
## 9  삼성전자 20110331  연
## 10 삼성전자 20100331  연</code></pre>
<p>다시 DART 홈페이지에 접속하여 데이터 추출에 필요한 값들을 찾도록 합니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-42"></span>
<img src="images/dart_api_search.png" alt="사업보고서 검색하기" width="70%" />
<p class="caption">
그림 6.6: 사업보고서 검색하기
</p>
</div>
<p>회사명은 삼성전자, 기간은 전체, 정기공시의 사업보고서 항목을 체크한 후 검색을 누르면 연말 사업보고서가 검색됩니다. 이 중 최근 보고서를 클릭합니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-43"></span>
<img src="images/dart_api_report.png" alt="사업보고서 확인하기" width="70%" />
<p class="caption">
그림 6.7: 사업보고서 확인하기
</p>
</div>
<p>url의 rcpNO 부분은 API 요청을 통해 발급받은 rcp_no 값과 동일하며, 해당 부분을 변경하여 매해 사업보고서에 해당하는 url을 생성할 수 있습니다.</p>
<p>다음으로 재무제표가 첨부된 엑셀 시트의 문서번호를 파악해야 합니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-44"></span>
<img src="images/dart_api_dcm.png" alt="문서번호 검색하기" width="70%" />
<p class="caption">
그림 6.8: 문서번호 검색하기
</p>
</div>
<p>상단의 [다운로드] 버튼을 우클릭 후 검사를 눌러 해당 부분의 HTML을 파악합니다. &lt;img&gt; 태그 위 &lt;a href&gt; 태그 내의 openPdfDownload 괄호안에는 ’20190401004781’과 ’6616741’라는 숫자가 있습니다. 이 중 앞의 숫자는 우리가 이미 구한 공시번호 즉 rcp_no에 해당하는 값이며, 뒤의 숫자는 문서번호에 해당하는 dcm_no에 해당하는 값이며, 이를 크롤링할 필요가 있습니다.</p>
<p>&lt;a href&gt; 태그의 Xpath는 다음과 같으며, 이를 이용하여 dcm_no에 해당하는 값을 크롤링 하도록 하겠습니다.</p>
<pre><code>//*[@id=&quot;north&quot;]/div[2]/ul/li[1]/a</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(httr)
<span class="kw">library</span>(rvest)

report_url =
<span class="st">  &#39;http://dart.fss.or.kr/dsaf001/main.do?rcpNo=20190401004781&#39;</span>

report_data =<span class="st"> </span><span class="kw">GET</span>(report_url) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">read_html</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_node</span>(<span class="dt">xpath =</span> <span class="st">&#39;//*[@id=&quot;north&quot;]/div[2]/ul/li[1]/a&#39;</span>)

<span class="kw">print</span>(report_data)</code></pre>
<pre><code>## {xml_node}
## &lt;a href=&quot;#download&quot; onclick=&quot;openPdfDownload(&#39;20190401004781&#39;, &#39;6616741&#39;); return false;&quot;&gt;
## [1] &lt;img src=&quot;/images/common/viewer_down.gif&quot; style=&quot;cursor:pointer;&quot; al ...</code></pre>
<ol style="list-style-type: decimal">
<li>report_url에 사업보고서의 url을 입력합니다.</li>
<li><code>GET()</code> 함수와 <code>read_html()</code> 함수를 통해 HTML 내용을 읽어옵니다.</li>
<li><code>html_node()</code> 함수 내에 위에서 구한 Xpath를 입력해서 해당 지점의 데이터를 추출합니다.</li>
</ol>
<p>&lt;a&gt; 태그의 onclick 속성 내 우리가 원하는 dcm_no 값이 위치하고 있으므로, 추가적으로 해당 데이터만을 추출하도록 하겠습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)

dcm_no =<span class="st"> </span>report_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">html_attr</span>(<span class="st">&#39;onclick&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match_all</span>(<span class="st">&#39;[0-9]+&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tail</span>(<span class="dv">1</span>)

<span class="kw">print</span>(dcm_no)</code></pre>
<pre><code>## [1] &quot;6616741&quot;</code></pre>
<ol style="list-style-type: decimal">
<li><code>html_attr()</code> 함수를 이용해 onclick 속성에 해당하는 값을 읽어옵니다.</li>
<li><code>str_match_all()</code> 함수 내에 정규표현식 [0-9]+ 을 이용하여 숫자에 해당하는 값들만 추출합니다.</li>
<li>rcp_no와 dcm_no가 list 형식으로 데이터가 추출되므로 <code>unlist()</code>를 통해 벡터 형태로 변경 후 <code>tail()</code> 함수를 통해 마지막 데이터 즉 dcm_no만 추출합니다.</li>
</ol>
<p>이제 rcp_no와 dcm_no를 이용하여 어떻게 엑셀 파일을 다운로드 받는지 확인하도록 합니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-47"></span>
<img src="images/dart_api_excel.png" alt="엑셀 다운로드 과정 확인하기" width="70%" />
<p class="caption">
그림 6.9: 엑셀 다운로드 과정 확인하기
</p>
</div>
<p>상단의 [다운로드] 버튼을 누르면 각종 첨부파일을 받을 수 있는 팝업창이 열립니다. 개발자도구 화면을 연 상태에서 [재무제표]에 해당하는 파일을 다운로드 받으면 해당 과정이 표시됩니다.</p>
<p>Request URL과 쿼리값을 살펴보면 <a href="http://dart.fss.or.kr/pdf/download/excel.do" class="uri">http://dart.fss.or.kr/pdf/download/excel.do</a> 주소에 rcp_no, dcm_no, lang 쿼리를 요청함이 확인됩니다. 이를 POST 형식의 코드로 나타내면 다음과 같습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r">excel_data =<span class="st"> </span>
<span class="st">  </span><span class="kw">POST</span>(<span class="st">&#39;http://dart.fss.or.kr/pdf/download/excel.do&#39;</span>,
       <span class="dt">query =</span> <span class="kw">list</span>(
         <span class="dt">rcp_no =</span> <span class="st">&#39;20190401004781&#39;</span>,
         <span class="dt">dcm_no =</span> dcm_no,
         <span class="dt">lang =</span> <span class="st">&#39;ko&#39;</span>
       ))

<span class="kw">print</span>(excel_data)</code></pre>
<pre><code>## Response [http://dart.fss.or.kr/pdf/download/excel.do?rcp_no=20190401004781&amp;dcm_no=6616741&amp;lang=ko]
##   Date: 2020-01-20 13:21
##   Status: 200
##   Content-Type: application/vnd.ms-excel
##   Size: 61.4 kB
## &lt;BINARY BODY&gt;</code></pre>
<pre><code>## NULL</code></pre>
<p>Response 값을 확인해보면 Content-Type이 excel이며 BINARY 파일입니다. 마지막으로 해당 파일을 저장합니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ifelse</span>(<span class="kw">dir.exists</span>(<span class="st">&#39;data/dart&#39;</span>), <span class="ot">FALSE</span>, <span class="kw">dir.create</span>(<span class="st">&#39;data/dart&#39;</span>))

<span class="kw">writeBin</span>(<span class="kw">content</span>(excel_data, <span class="st">&#39;raw&#39;</span>), <span class="st">&#39;data/dart/005930_20190401004781.xls&#39;</span>)</code></pre>
<p>data 폴더 내에 dart 폴더를 생성한 후, <code>writeBin()</code> 함수를 이용해 바이너리 파일(엑셀 파일)을 저장합니다.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-50"></span>
<img src="images/dart_api_excel_down.png" alt="엑셀 데이터 확인하기" width="70%" />
<p class="caption">
그림 6.10: 엑셀 데이터 확인하기
</p>
</div>
<p>저장된 엑셀 파일을 확인해보면 재무제표 항목이 포함되어 있습니다. 이 중 연결 재무상태표 시트의 데이터만 불러오도록 하겠습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(readxl)
dart_data =<span class="st"> </span><span class="kw">read_xls</span>(<span class="st">&#39;data/dart/005930_20190401004781.xls&#39;</span>, <span class="dt">sheet =</span> <span class="st">&#39;연결 재무상태표&#39;</span>)

<span class="kw">head</span>(dart_data)</code></pre>
<pre><code>## # A tibble: 6 x 4
##   `연결 재무상태표`        ...2     ...3     ...4    
##   &lt;chr&gt;                    &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;   
## 1 제 50 기 2018.12.31 현재 &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;    
## 2 제 49 기 2017.12.31 현재 &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;    
## 3 제 48 기 2016.12.31 현재 &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;    
## 4 (단위 : 백만원)          &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;    
## 5 &lt;NA&gt;                     제 50 기 제 49 기 제 48 기
## 6 자산                     &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;</code></pre>
<div id="section-41" class="section level4">
<h4><span class="header-section-number">6.3.3.1</span> 10년치 재무제표 다운로드</h4>
<p>위 과정을 응용하여 원하는 종목의 10년치 재무제표 데이터에 해당하는 엑셀 파일을 다운로드 받는 방법은 다음과 같습니다.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(jsonlite)

ticker =<span class="st"> &#39;005930&#39;</span>

url =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;http://dart.fss.or.kr/api/search.json?&#39;</span>,<span class="st">&#39;auth=&#39;</span>,dart_api,
             <span class="st">&#39;&amp;crp_cd=&#39;</span>, ticker, <span class="st">&#39;&amp;start_dt=19990101&amp;bsn_tp=A001&#39;</span>)

dart_data =<span class="st"> </span><span class="kw">fromJSON</span>(url)
dart_rcp_no =<span class="st"> </span>dart_data<span class="op">$</span>list<span class="op">$</span>rcp_no

<span class="cf">for</span> (i <span class="cf">in</span> dart_rcp_no) {
  
  report_url =
<span class="st">    </span><span class="kw">paste0</span>(<span class="st">&#39;http://dart.fss.or.kr/dsaf001/main.do?rcpNo=&#39;</span>, i)
  
  report_data =<span class="st"> </span><span class="kw">GET</span>(report_url) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">read_html</span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">html_node</span>(<span class="dt">xpath =</span> <span class="st">&#39;//*[@id=&quot;north&quot;]/div[2]/ul/li[1]/a&#39;</span>)
  
  dcm_no =<span class="st"> </span>report_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">html_attr</span>(<span class="st">&#39;onclick&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">str_match_all</span>(<span class="st">&#39;[0-9]+&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tail</span>(<span class="dv">1</span>)
  
  excel_data =<span class="st"> </span>
<span class="st">    </span><span class="kw">POST</span>(<span class="st">&#39;http://dart.fss.or.kr/pdf/download/excel.do&#39;</span>,
         <span class="dt">query =</span> <span class="kw">list</span>(
           <span class="dt">rcp_no =</span> i,
           <span class="dt">dcm_no =</span> dcm_no,
           <span class="dt">lang =</span> <span class="st">&#39;ko&#39;</span>
         ))
  
  <span class="kw">ifelse</span>(<span class="kw">dir.exists</span>(<span class="st">&#39;data/dart&#39;</span>), <span class="ot">FALSE</span>, <span class="kw">dir.create</span>(<span class="st">&#39;data/dart&#39;</span>))
  
  <span class="kw">writeBin</span>(<span class="kw">content</span>(excel_data, <span class="st">&#39;raw&#39;</span>),
           <span class="kw">paste0</span>(<span class="st">&#39;data/dart/&#39;</span>,ticker,<span class="st">&#39;_&#39;</span>,i,<span class="st">&#39;.xls&#39;</span>))
  
  <span class="kw">Sys.sleep</span>(<span class="dv">1</span>)
  
}</code></pre>
<ol style="list-style-type: decimal">
<li>ticker에 원하는 종목의 티커를 입력합니다.</li>
<li>인증키와 티커를 이용해 API를 요청할 url을 생성합니다.</li>
<li><code>fromJSON()</code> 함수를 이용해 JSON 데이터를 불러옵니다.</li>
<li>데이터 중 공시번호에 해당하는 rcp_no만 선택하여 저장합니다.</li>
<li>for loop 구문을 이용하여 모든 공시번호에 해당하는 작업을 반복합니다.</li>
<li>공시번호를 이용해 사업보고의 url을 생성한 후 report_url에 저장합니다.</li>
<li>Xpath를 이용해 공시번호와 문서번호가 있는 데이터를 크롤링합니다.</li>
<li><code>str_match_all()</code> 함수 내 정규표현식을 이용하여 문서번호에 해당하는 dcm_no를 추출합니다.</li>
<li><code>POST()</code> 함수 내에 rcp_no와 dcm_no를 쿼리로 이용하여 엑셀 파일을 요청합니다.</li>
<li><code>writeBin()</code> 함수를 이용하여 data/dart 폴더 내에 티커_공시번호(rcp_no).xls로 엑셀 파일을 저장합니다.</li>
</ol>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-53"></span>
<img src="images/dart_api_excel_list.png" alt="엑셀 리스트 확인하기" width="70%" />
<p class="caption">
그림 6.11: 엑셀 리스트 확인하기
</p>
</div>
<p>해당 폴더를 확인해보면 원하는 종목의 10년치 재무제표가 있는 엑셀 파일이 다운로드 되며, 사업보고서에 엑셀 파일이 존재하지 않는 경우 용량이 0KB인 파일이 저장됩니다. (가끔 재무제표가 PDF 형식으로 업로드 되는 경우가 있습니다.)</p>

</div>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="14">
<li id="fn14"><p><a href="https://finance.naver.com/item/fchart.nhn?code=005930" class="uri">https://finance.naver.com/item/fchart.nhn?code=005930</a><a href="section-29.html#fnref14" class="footnote-back">↩</a></p></li>
<li id="fn15"><p>플래쉬가 차단되어 화면이 나오지 않는 경우, 주소창의 왼쪽 상단에 위치한 자물쇠 버튼을 클릭한 다음, Flash를 허용으로 바꾼 후 새로고침을 누르면 차트가 나오게 됩니다.<a href="section-29.html#fnref15" class="footnote-back">↩</a></p></li>
<li id="fn16"><p><a href="http://comp.fnguide.com/" class="uri">http://comp.fnguide.com/</a><a href="section-29.html#fnref16" class="footnote-back">↩</a></p></li>
<li id="fn17"><p>분모에 사용되는 재무데이터의 구체적인 항목과 발행주식수를 계산하는 방법의 차이로 인해 여러 업체에서 제공하는 가치지표와 다소 차이가 발생할 수 있습니다.<a href="section-29.html#fnref17" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="section-23.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="section-42.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
},
"split_bib": false
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>

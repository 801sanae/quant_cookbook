# API를 이용한 데이터 수집

본 장과 다음 장에서는 본격적으로 데이터를 수집하는 방법에 대해 배우도록 하겠습니다. 그 중 해당 장에서는 API를 이용하여 데이터를 수집하는 방법에 대해 살펴보도록 합니다.

API 제공자는 본인이 가진 데이터베이스를 다른 누군가가 쉽게 사용할 수 있는 형태로 가지고 있으며, 해당 데이터베이스에 접근할 수 있는 열쇠인 API 주소를 가진 사람은 이를 언제든지 사용할 수 있습니다.


<div class="figure" style="text-align: center">
<img src="images/api_api.png" alt="API 개념" width="294" />
<p class="caption">(\#fig:unnamed-chunk-1)API 개념</p>
</div>

API 주소만 가지고 있다면 데이터를 언제, 어디서, 누구나 쉽게 이용할 수 있다는 장점이 있습니다. 또한 대부분의 경우 사용자가 필요한 데이터만을 가지고 있으므로 접속 속도가 빠르며, 데이터를 가공하는 번거로움도 줄어듭니다.
해외의 경우 금융 데이터를 API의 형태로 제공하는 업체가 많으므로, 이를 잘만 활용한다면 매우 손쉽게 퀀트 투자에 필요한 데이터를 수집할 수 있습니다.

## API를 이용한 Quandl 데이터 다운로드

데이터 제공업체 Quandl은 일부 데이터를 무료로 제공하며, API를 통해서 이를 다운로드 받을 수 있습니다.^[자세한 내용은 https://docs.quandl.com/ 에서 확인할 수 있습니다.] 해당 책에서는 예제로써 애플(AAPL)의 주가를 다운로드 받도록 하겠습니다. csv 형식의 API 주소는 다음과 같습니다.

```
https://www.quandl.com/api/v3/datasets/WIKI/AAPL/data.csv?api_key=xw3NU3xLUZ7vZgrz5QnG
```

위 주소를 웹 브라우저 주소 창에 직접 입력하면 csv 형식의 파일이 다운로드 되며, 이를 열어보면 애플의 주가에 해당하는 정보들이 다운로드 됨이 확인됩니다.

<div class="figure" style="text-align: center">
<img src="images/api_apple_csv.png" alt="API 주소를 이용한 데이터 다운로드" width="100%" />
<p class="caption">(\#fig:unnamed-chunk-2)API 주소를 이용한 데이터 다운로드</p>
</div>

그러나 웹 브라우저에 해당 주소를 입력하여 csv 파일을 다운로드 받고, 이를 다시 R에서 불러오는 작업은 무척이나 비효율 적입니다. R 내에서 API 주소를 이용하여 직접 데이터를 다운로드 받아올 수 있습니다.


```r
url.aapl = "https://www.quandl.com/api/v3/datasets/WIKI/AAPL/
data.csv?api_key=xw3NU3xLUZ7vZgrz5QnG"
data.aapl = read.csv(url.aapl)

head(data.aapl)
```

```
##         Date   Open   High    Low   Close   Volume Ex.Dividend Split.Ratio
## 1 2018-03-27 173.68 175.15 166.92 168.340 38962839           0           1
## 2 2018-03-26 168.07 173.10 166.44 172.770 36272617           0           1
## 3 2018-03-23 168.39 169.92 164.94 164.940 40248954           0           1
## 4 2018-03-22 170.00 172.68 168.60 168.845 41051076           0           1
## 5 2018-03-21 175.04 175.09 171.26 171.270 35247358           0           1
## 6 2018-03-20 175.24 176.80 174.94 175.240 19314039           0           1
##   Adj..Open Adj..High Adj..Low Adj..Close Adj..Volume
## 1    173.68    175.15   166.92    168.340    38962839
## 2    168.07    173.10   166.44    172.770    36272617
## 3    168.39    169.92   164.94    164.940    40248954
## 4    170.00    172.68   168.60    168.845    41051076
## 5    175.04    175.09   171.26    171.270    35247358
## 6    175.24    176.80   174.94    175.240    19314039
```

url1에 해당 주소를 입력한 후, `read.csv()` 함수를 이용하여 간단하게 csv 파일을 불러올 수 있습니다.

API 주소를 조금만 수정하면, 다른 종목의 데이터도 다운로드 받을 수 있습니다. 위의 주소에서 애플의 티커에 해당하는 AAPL를 넷플렉스의 티커에 해당하는 NFLX로 변경하여 데이터를 다운로드 받아보도록 하겠습니다.


```r
url.nflx = 'https://www.quandl.com/api/v3/datasets/WIKI/NFLX/
data.csv?api_key=xw3NU3xLUZ7vZgrz5QnG'
data.nflx = read.csv(url.nflx)

head(data.nflx)
```

```
##         Date   Open   High     Low  Close   Volume Ex.Dividend Split.Ratio
## 1 2018-03-27 322.49 322.90 297.000 300.69 11890994           0           1
## 2 2018-03-26 309.36 321.03 302.000 320.35 11906279           0           1
## 3 2018-03-23 307.41 310.73 300.360 300.94  9226978           0           1
## 4 2018-03-22 313.07 314.12 305.660 306.70  7920524           0           1
## 5 2018-03-21 316.35 319.40 314.511 316.48  5016980           0           1
## 6 2018-03-20 313.26 319.50 312.800 317.50  5922296           0           1
##   Adj..Open Adj..High Adj..Low Adj..Close Adj..Volume
## 1    322.49    322.90  297.000     300.69    11890994
## 2    309.36    321.03  302.000     320.35    11906279
## 3    307.41    310.73  300.360     300.94     9226978
## 4    313.07    314.12  305.660     306.70     7920524
## 5    316.35    319.40  314.511     316.48     5016980
## 6    313.26    319.50  312.800     317.50     5922296
```

넷플릭스의 주가 역시 손쉽게 다운로드 받을 수 있음이 확인됩니다.

## `getSymbols()` 함수를 이용한 API 다운로드

앞선 예에서 API 주소를 이용할 경우 매우 간단하게 데이터를 수집할 있음을 살펴 보았습니다. 그러나 해당 방법에는 여러 단점 또한 존재합니다. 먼저, 원하는 항목에 대한 API를 일일이 얻는 것이 힘든 일입니다. 또한 Quandl의 경우 무료로 얻을 수 있는 정보에 제한이 있으며, 다운로드 양에 대한 제한도 있습니다. 한 두 종목의 경우 해당 방법으로 데이터를 수집할 수 있지만, 전 종목의 데이터를 해당 방법으로 구하는 것은 사실상 불가능 합니다.

다행히 야후 파이낸스에서도 주가 데이터를 무료로 제공하며, `quantmod` 패키지의 `getSymbols()` 함수는 해당 API에 접속하여 데이터를 다운로드 받아옵니다.

### 주가 다운로드

`getSymbols()` 함수의 기본적인 사용법은 매우 간단합니다. 괄호 안에 다운로드 받고자 하는 종목의 티커를 입력하면 됩니다. 아래의 코드는 애플의 티커인 "AAPL"을 입력한 경우입니다. 티커와 동일한 변수인 AAPL이 생성되며, 주가 데이터가 다운로드 된 후 xts 형태로 입력됩니다.


```r
library(quantmod)
getSymbols('AAPL')
```

```
## [1] "AAPL"
```

```r
head(AAPL)
```

```
##            AAPL.Open AAPL.High AAPL.Low AAPL.Close AAPL.Volume
## 2007-01-03  12.32714  12.36857 11.70000   11.97143   309579900
## 2007-01-04  12.00714  12.27857 11.97429   12.23714   211815100
## 2007-01-05  12.25286  12.31428 12.05714   12.15000   208685400
## 2007-01-08  12.28000  12.36143 12.18286   12.21000   199276700
## 2007-01-09  12.35000  13.28286 12.16429   13.22429   837324600
## 2007-01-10  13.53571  13.97143 13.35000   13.85714   738220000
##            AAPL.Adjusted
## 2007-01-03      10.48732
## 2007-01-04      10.72009
## 2007-01-05      10.64375
## 2007-01-08      10.69631
## 2007-01-09      11.58486
## 2007-01-10      12.13926
```

다운로드 결과로써 총 6개의 열이 생성됩니다. Open은 시가, High는 고가, Low는 저가, Close는 종가를 의미합니다. 또한, Volume은 거래량을 의미하며, Adjusted는 배당이 반영된 수정주가를 의미합니다. 이 중 가장 많이 사용되는 데이터는 Adjusted, 즉 배당이 반영된 수정주가입니다. `Ad()` 함수는 `getSymbols()` 함수를 통해 다운로드 받은 데이터에서 수정주가만을 선택하여 줍니다. 시계열 그래프를 그려주는 `chart_Series()`와 함께 수정주가를 그리면 다음과 같습니다.


```r
chart_Series(Ad(AAPL))
```

<img src="03-api_files/figure-html/unnamed-chunk-6-1.png" width="672" />

시계열 기간을 입력하지 않을 경우 2007년 1월부터 현재까지의 데이터가 다운로드 되며, 추가적인 입력 변수를 통해 원하는 기간의 데이터를 다운로드 받을 수도 있습니다. from에는 시작 시점을, to에는 종료 시점을 입력하여 주면, 해당 시점의 데이터가 다운로드 받아짐이 확인됩니다.

`getSymbols()` 함수를 통해 다운로드 받은 데이터는 자동으로 티커와 동일한 변수명에 저장됩니다. 만일 티커명이 아닌 원하는 변수명에 데이터를 저장하고 싶을 경우, auto.assign 인자를 FALSE로 설정해주면 다운로드 받은 데이터가 원하는 변수에 저장됩니다.


```r
data = getSymbols('AAPL', from = '2000-01-01', to = '2018-12-31', auto.assign = FALSE)
head(data)
```

```
##            AAPL.Open AAPL.High AAPL.Low AAPL.Close AAPL.Volume
## 2000-01-03  3.745536  4.017857 3.631696   3.997768   133949200
## 2000-01-04  3.866071  3.950893 3.613839   3.660714   128094400
## 2000-01-05  3.705357  3.948661 3.678571   3.714286   194580400
## 2000-01-06  3.790179  3.821429 3.392857   3.392857   191993200
## 2000-01-07  3.446429  3.607143 3.410714   3.553571   115183600
## 2000-01-10  3.642857  3.651786 3.383929   3.491071   126266000
##            AAPL.Adjusted
## 2000-01-03      3.502161
## 2000-01-04      3.206892
## 2000-01-05      3.253822
## 2000-01-06      2.972241
## 2000-01-07      3.113032
## 2000-01-10      3.058280
```

한번에 여러 종목의 주가를 다운로드 받을 수도 있습니다. 아래 예제와 같이 페이스북과 엔비디아의 티커인 FB와 NVDA를 ticker 변수에 입력하여 주고, `getSymbols()` 함수에 티커들을 입력한 변수를 넣어주면 두 종목의 주가가 동시에 다운로드 됩니다.


```r
ticker = c('FB', 'NVDA') 
getSymbols(ticker)
```

```
## [1] "FB"   "NVDA"
```

```r
head(FB)
```

```
##            FB.Open FB.High FB.Low FB.Close FB.Volume FB.Adjusted
## 2012-05-18   42.05   45.00  38.00    38.23 573576400       38.23
## 2012-05-21   36.53   36.66  33.00    34.03 168192700       34.03
## 2012-05-22   32.61   33.59  30.94    31.00 101786600       31.00
## 2012-05-23   31.37   32.50  31.36    32.00  73600000       32.00
## 2012-05-24   32.95   33.21  31.77    33.03  50237200       33.03
## 2012-05-25   32.90   32.95  31.11    31.91  37149800       31.91
```

```r
head(NVDA)
```

```
##            NVDA.Open NVDA.High NVDA.Low NVDA.Close NVDA.Volume
## 2007-01-03  24.71333  25.01333 23.19333   24.05333    28870500
## 2007-01-04  23.96667  24.05333 23.35333   23.94000    19932400
## 2007-01-05  23.37333  23.46667 22.28000   22.44000    31083600
## 2007-01-08  22.52000  23.04000 22.13333   22.60667    16431700
## 2007-01-09  22.64000  22.79333 22.14000   22.16667    19104100
## 2007-01-10  21.93333  23.46667 21.60000   23.26000    27718600
##            NVDA.Adjusted
## 2007-01-03      22.19124
## 2007-01-04      22.08669
## 2007-01-05      20.70281
## 2007-01-08      20.85657
## 2007-01-09      20.45063
## 2007-01-10      21.45933
```

### 국내 종목 주가 다운로드

`getSymbols()` 함수를 이용하면 미국뿐 아니라 국내 종목의 주가를 다운로드 받을 수도 있습니다. 국내 종목의 티커는 총 6자리로 구성되어 있으며, 해당 함수에 입력되는 티커는 코스피 상장 종목의 경우 "티커.KS", 코스닥 상장 종목의 경우 "티커.KQ"의 형태로 입력해 주어야 합니다.

먼저 코스피 상장종목인 삼성전자 데이터의 다운로드 예시입니다. 


```r
getSymbols('005930.KS', from = '2000-01-01', to = '2018-12-31')
```

```
## [1] "005930.KS"
```

```r
tail(Ad(`005930.KS`))
```

```
##            005930.KS.Adjusted
## 2018-12-20           38293.23
## 2018-12-21           38293.23
## 2018-12-24           38441.84
## 2018-12-26           37996.00
## 2018-12-27           38250.00
## 2018-12-28           38700.00
```

삼성전자의 티커인 005930에 .KS를 붙여 함수에 입력할 경우, 티커명에 해당하는 005930.KS 변수명에 데이터가 저장됩니다. 변수명에 콤마(.)가 있는 관계로, `Ad` 함수를 통해 수정주가를 확인하고자 할 때는 변수명의 앞뒤에 억음부호(`)를 붙여주어야 합니다.

국내 종목의 경우 가끔 수정주가에 오류가 발생하는 경우가 많습니다. 배당이 반영된 값 보다는 단순 종가(Close) 데이터를 사용하기를 권장합니다.


```r
tail(Cl(`005930.KS`))
```

```
##            005930.KS.Close
## 2018-12-20           38650
## 2018-12-21           38650
## 2018-12-24           38800
## 2018-12-26           38350
## 2018-12-27           38250
## 2018-12-28           38700
```

`Cl()` 함수는 Close, 즉 종가만을 선택하여 주며, 사용 방법은 기존 `Ad()` 함수와 동일합니다. 비록 배당을 고려할 수는 없지만, 전반적으로 오류가 없는 데이터를 사용할 수 있습니다.

다음은 코스닥 상장종목인 셀트리온제약의 예시이며, 티커인 068670에 .KQ를 붙여 함수에 입력합니다. 역시나 데이터가 다운로드 되어 티커명의 변수에 저장됩니다.


```r
getSymbols("068760.KQ", from = '2000-01-01', to = '2018-12-31')
```

```
## [1] "068760.KQ"
```

```r
tail(Cl(`068760.KQ`))
```

```
##            068760.KQ.Close
## 2018-01-24           95100
## 2018-01-25           97300
## 2018-01-26           97400
## 2018-01-29           99900
## 2018-01-30           99500
## 2018-01-31           97500
```

### FRED 데이터 다운로드

미국 및 각국의 중요 경제지표 데이터를 살펴볼 때, 가장 많이 참조되는 곳 중 하나가 미 연방 준비 은행에서 관리하는 Fred Economic Date 입니다. `getSymbols()` 함수를 통해 FRED 데이터를 다운로드 받을 수 있습니다. 먼저 미 국채 10년물 금리를 다운로드 받는 예제를 살펴보도록 하겠습니다.


```r
getSymbols('DGS10', src='FRED')
```

```
## [1] "DGS10"
```

```r
chart_Series(DGS10)
```

<img src="03-api_files/figure-html/unnamed-chunk-12-1.png" width="672" />

먼저 미 국채 10년물 금리에 해당하는 티커인 "DGS10"을 입력해 줍니다. 그 후, 데이터 소스에 해당하는 src에 "FRED"를 입력해 주면, 해당 데이터가 다운로드 됩니다. `chart_Series`를 통해 해당 데이터를 그래프로 나타내면 다음과 같습니다.

각 항목 별 티커를 찾는 방법은 매우 간단합니다. 먼저 FRED의 홈페이지^[https://fred.stlouisfed.org/]에 접속하여, 원하는 데이터를 검색합니다. 예시로써 원/달러 환율에 해당하는 South Korea / U.S. Foreign Exchange Rate 를 검색하여 원하는 페이지에 접속합니다. 이 중 페이지 주소에서 /series/ 다음에 위치하는 DEXKOUS 가 해당 항목의 티커입니다.

<div class="figure" style="text-align: center">
<img src="images/api_fred.png" alt="FRED 사이트 내 원/달러 환율의 티커 확인" width="788" />
<p class="caption">(\#fig:unnamed-chunk-13)FRED 사이트 내 원/달러 환율의 티커 확인</p>
</div>

해당 티커를 입력하면, 홈페이지와 동일한 데이터가 다운로드 됨이 확인됩니다. 이 외에도 509,000 여개의 방대한 FRED 데이터를 해당 함수를 통해 손쉽게 R에서 다운로드 받을 수 있습니다.


```r
getSymbols('DEXKOUS', src='FRED')
```

```
## [1] "DEXKOUS"
```

```r
tail(DEXKOUS)
```

```
##            DEXKOUS
## 2019-05-31 1190.50
## 2019-06-03 1180.97
## 2019-06-04 1180.58
## 2019-06-05 1178.24
## 2019-06-06 1179.51
## 2019-06-07 1181.27
```

```r
chart_Series(DEXKOUS)
```

<img src="03-api_files/figure-html/unnamed-chunk-14-1.png" width="672" />
